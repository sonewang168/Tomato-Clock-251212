<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>ğŸ… ç•ªèŒ„é˜ Pro</title>
    <link rel="manifest" href="manifest.json">
    <style>
        /* ========== ä¸»é¡Œè®Šæ•¸ ========== */
        :root {
            --bg-primary: #000000;
            --bg-secondary: #1c1c1e;
            --bg-tertiary: #2c2c2e;
            --bg-card: #1c1c1e;
            --text-primary: #ffffff;
            --text-secondary: #8e8e93;
            --text-tertiary: #636366;
            --accent-red: #ff453a;
            --accent-orange: #ff9f0a;
            --accent-green: #30d158;
            --accent-blue: #0a84ff;
            --accent-cyan: #64d2ff;
            --accent-purple: #bf5af2;
            --accent-pink: #ff375f;
            --border: #38383a;
            --separator: #38383a;
        }

        /* æ·ºè‰²ä¸»é¡Œ */
        [data-theme="light"] {
            --bg-primary: #f2f2f7;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e5e5ea;
            --bg-card: #ffffff;
            --text-primary: #000000;
            --text-secondary: #6c6c70;
            --text-tertiary: #8e8e93;
            --border: #c6c6c8;
            --separator: #c6c6c8;
        }

        /* æ£®æ—ä¸»é¡Œ */
        [data-theme="forest"] {
            --bg-primary: #0d1f0d;
            --bg-secondary: #1a2f1a;
            --bg-tertiary: #2a3f2a;
            --accent-green: #4ade80;
            --accent-red: #f87171;
        }

        /* æµ·æ´‹ä¸»é¡Œ */
        [data-theme="ocean"] {
            --bg-primary: #0c1929;
            --bg-secondary: #132f4c;
            --bg-tertiary: #1e4976;
            --accent-blue: #5ea9ff;
            --accent-cyan: #80deea;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            transition: background 0.3s, color 0.3s;
        }

        /* ========== é–‹æ©Ÿå‹•ç•« ========== */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #0f0f1a 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.8s ease, visibility 0.8s ease;
        }

        .splash-screen.fade-out {
            opacity: 0;
            visibility: hidden;
        }

        .splash-container {
            position: relative;
            width: 200px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tech-grid {
            position: absolute;
            width: 300px;
            height: 300px;
            background-image: 
                linear-gradient(rgba(100, 210, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(100, 210, 255, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
            animation: gridPulse 4s ease-in-out infinite;
        }

        @keyframes gridPulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }

        .glow-ring {
            position: absolute;
            border-radius: 50%;
            border: 2px solid transparent;
            animation: ringRotate 3s linear infinite;
        }

        .glow-ring:nth-child(1) {
            width: 180px;
            height: 180px;
            border-top-color: #64d2ff;
            border-right-color: #64d2ff;
            animation-duration: 3s;
        }

        .glow-ring:nth-child(2) {
            width: 150px;
            height: 150px;
            border-bottom-color: #bf5af2;
            border-left-color: #bf5af2;
            animation-duration: 2.5s;
            animation-direction: reverse;
        }

        .glow-ring:nth-child(3) {
            width: 120px;
            height: 120px;
            border-top-color: #30d158;
            animation-duration: 2s;
        }

        @keyframes ringRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .splash-text {
            font-size: 48px;
            font-weight: 700;
            color: #64d2ff;
            text-shadow: 0 0 30px rgba(100, 210, 255, 0.8);
            animation: textGlow 2s ease-in-out infinite;
            z-index: 10;
        }

        @keyframes textGlow {
            0%, 100% { text-shadow: 0 0 30px rgba(100, 210, 255, 0.8); }
            50% { text-shadow: 0 0 60px rgba(100, 210, 255, 1), 0 0 100px rgba(191, 90, 242, 0.5); }
        }

        .splash-subtitle {
            margin-top: 30px;
            font-size: 14px;
            color: var(--text-secondary);
            letter-spacing: 2px;
        }

        .splash-version {
            margin-top: 10px;
            font-size: 12px;
            color: var(--accent-cyan);
        }

        /* ========== ä¸»å®¹å™¨ ========== */
        .app-container {
            max-width: 500px;
            margin: 0 auto;
            padding-bottom: 100px;
            min-height: 100vh;
        }

        /* ========== ç‹€æ…‹åˆ— ========== */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .status-time {
            color: var(--text-primary);
        }

        .status-icons {
            display: flex;
            gap: 6px;
            font-size: 12px;
        }

        /* ========== å°èˆªåˆ— ========== */
        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px 16px;
        }

        .nav-title {
            font-size: 28px;
            font-weight: 700;
        }

        .nav-actions {
            display: flex;
            gap: 12px;
        }

        .nav-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-primary);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, background 0.2s;
        }

        .nav-btn:hover {
            transform: scale(1.1);
            background: var(--accent-blue);
        }

        /* ========== é é¢ ========== */
        .page {
            display: none;
            padding: 0 20px;
        }

        .page.active {
            display: block;
        }

        /* ========== æ¨¡å¼åˆ‡æ› ========== */
        .mode-switcher {
            display: flex;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 20px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: var(--accent-blue);
            color: #fff;
        }

        /* ========== è¨ˆæ™‚å™¨ ========== */
        .timer-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
        }

        .timer-ring {
            position: relative;
            width: 280px;
            height: 280px;
        }

        .timer-ring svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .timer-bg {
            fill: none;
            stroke: var(--bg-tertiary);
            stroke-width: 8;
        }

        .timer-progress {
            fill: none;
            stroke: var(--accent-green);
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 816;
            stroke-dashoffset: 0;
            transition: stroke-dashoffset 0.5s ease, stroke 0.3s;
            filter: drop-shadow(0 0 10px var(--accent-green));
        }

        .timer-progress.rest {
            stroke: var(--accent-cyan);
            filter: drop-shadow(0 0 10px var(--accent-cyan));
        }

        .timer-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .timer-emoji {
            font-size: 40px;
            margin-bottom: 8px;
        }

        .timer-display {
            font-size: 56px;
            font-weight: 200;
            font-variant-numeric: tabular-nums;
            letter-spacing: -2px;
        }

        .timer-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        /* ========== æ§åˆ¶æŒ‰éˆ• ========== */
        .controls {
            display: flex;
            gap: 20px;
            margin-top: 30px;
            align-items: center;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .control-btn:hover {
            transform: scale(1.1);
        }

        .start-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: var(--accent-green);
            color: #000;
            font-size: 28px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(48, 209, 88, 0.4);
        }

        .start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 30px rgba(48, 209, 88, 0.6);
        }

        .start-btn.running {
            background: var(--accent-orange);
            box-shadow: 0 4px 20px rgba(255, 159, 10, 0.4);
        }

        .start-btn.rest-mode {
            background: var(--accent-cyan);
            box-shadow: 0 4px 20px rgba(100, 210, 255, 0.4);
        }

        .start-btn-text {
            font-size: 11px;
            font-weight: 600;
        }

        /* ========== ç•ªèŒ„è¨ˆæ•¸ ========== */
        .pomodoro-count {
            display: flex;
            gap: 8px;
            margin-top: 24px;
        }

        .pomodoro-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            transition: all 0.3s;
        }

        .pomodoro-dot.completed {
            background: var(--accent-red);
            box-shadow: 0 0 10px var(--accent-red);
        }

        .pomodoro-dot.long-break {
            background: var(--accent-purple);
        }

        /* ========== çµ±è¨ˆå¡ç‰‡ ========== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 20px 0;
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-green);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* ========== å¾…è¾¦äº‹é … ========== */
        .todo-section {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 16px;
            margin: 20px 0;
        }

        .todo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .todo-title {
            font-size: 16px;
            font-weight: 600;
        }

        .todo-add-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background: var(--accent-blue);
            color: #fff;
            font-size: 18px;
            cursor: pointer;
        }

        .todo-input-container {
            display: none;
            margin-bottom: 12px;
        }

        .todo-input-container.show {
            display: flex;
            gap: 8px;
        }

        .todo-input {
            flex: 1;
            padding: 10px 12px;
            border: none;
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 14px;
        }

        .todo-submit {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            background: var(--accent-green);
            color: #000;
            font-weight: 600;
            cursor: pointer;
        }

        .todo-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .todo-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .todo-item:hover {
            background: var(--bg-primary);
        }

        .todo-item.active {
            border-left: 3px solid var(--accent-green);
        }

        .todo-item.completed .todo-text {
            text-decoration: line-through;
            color: var(--text-tertiary);
        }

        .todo-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--text-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s;
        }

        .todo-item.completed .todo-checkbox {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: #000;
        }

        .todo-text {
            flex: 1;
            font-size: 14px;
        }

        .todo-pomodoros {
            font-size: 12px;
            color: var(--accent-red);
        }

        .todo-delete {
            opacity: 0;
            color: var(--accent-red);
            cursor: pointer;
        }

        .todo-item:hover .todo-delete {
            opacity: 1;
        }

        /* ========== åœ–è¡¨ ========== */
        .chart-container {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 16px;
            margin: 20px 0;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
        }

        .chart-tabs {
            display: flex;
            gap: 8px;
        }

        .chart-tab {
            padding: 4px 12px;
            border: none;
            border-radius: 12px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
        }

        .chart-tab.active {
            background: var(--accent-blue);
            color: #fff;
        }

        .chart-canvas {
            width: 100%;
            height: 150px;
        }

        .chart-bars {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            height: 120px;
            padding: 0 10px;
        }

        .chart-bar-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            flex: 1;
        }

        .chart-bar {
            width: 24px;
            background: linear-gradient(to top, var(--accent-green), var(--accent-cyan));
            border-radius: 4px 4px 0 0;
            min-height: 4px;
            transition: height 0.5s;
        }

        .chart-bar-label {
            font-size: 10px;
            color: var(--text-tertiary);
        }

        /* ========== ç™½å™ªéŸ³ ========== */
        .ambient-section {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 16px;
            margin: 20px 0;
        }

        .ambient-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .ambient-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .ambient-btn {
            aspect-ratio: 1;
            border: none;
            border-radius: 12px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .ambient-btn span {
            font-size: 10px;
            color: var(--text-secondary);
        }

        .ambient-btn.active {
            background: var(--accent-blue);
            transform: scale(1.05);
        }

        .ambient-btn:hover {
            transform: scale(1.05);
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 12px;
        }

        .volume-slider {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            background: var(--bg-tertiary);
            border-radius: 2px;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent-blue);
            cursor: pointer;
        }

        /* ========== ä¼‘æ¯æ´»å‹• ========== */
        .rest-activities {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 16px;
            margin: 20px 0;
        }

        .rest-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-secondary);
        }

        .rest-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .rest-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 8px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            transition: transform 0.2s;
        }

        .rest-item:hover {
            transform: scale(1.05);
        }

        .rest-item-icon {
            font-size: 24px;
        }

        .rest-item-text {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
        }

        /* ========== è¨­å®šç¾¤çµ„ ========== */
        .settings-group {
            background: var(--bg-secondary);
            border-radius: 16px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .settings-header {
            padding: 12px 16px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            border-bottom: 1px solid var(--separator);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .setting-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .setting-icon.red { background: var(--accent-red); }
        .setting-icon.orange { background: var(--accent-orange); }
        .setting-icon.green { background: var(--accent-green); }
        .setting-icon.blue { background: var(--accent-blue); }
        .setting-icon.cyan { background: var(--accent-cyan); }
        .setting-icon.purple { background: var(--accent-purple); }

        .setting-label {
            font-size: 15px;
        }

        .setting-value {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .setting-input {
            width: 60px;
            padding: 8px;
            border: none;
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 15px;
            text-align: center;
        }

        /* iOS é–‹é—œ */
        .ios-switch {
            width: 51px;
            height: 31px;
            background: var(--bg-tertiary);
            border-radius: 15.5px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }

        .ios-switch::after {
            content: '';
            position: absolute;
            width: 27px;
            height: 27px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .ios-switch.active {
            background: var(--accent-green);
        }

        .ios-switch.active::after {
            transform: translateX(20px);
        }

        /* ========== ä¸»é¡Œé¸æ“‡å™¨ ========== */
        .theme-selector {
            display: flex;
            gap: 12px;
            padding: 12px;
        }

        .theme-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .theme-option.active {
            border-color: var(--accent-blue);
            transform: scale(1.1);
        }

        .theme-option.dark { background: linear-gradient(135deg, #000 50%, #1c1c1e 50%); }
        .theme-option.light { background: linear-gradient(135deg, #f2f2f7 50%, #fff 50%); }
        .theme-option.forest { background: linear-gradient(135deg, #0d1f0d 50%, #1a2f1a 50%); }
        .theme-option.ocean { background: linear-gradient(135deg, #0c1929 50%, #132f4c 50%); }

        /* ========== é˜è²é¸æ“‡å™¨ ========== */
        .chime-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px;
        }

        .chime-option {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chime-option.active {
            background: var(--accent-blue);
            color: #fff;
        }

        /* ========== åº•éƒ¨å°èˆª ========== */
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 8px 0;
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
        }

        .tab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            background: none;
            border: none;
            color: var(--text-tertiary);
            font-size: 10px;
            cursor: pointer;
            padding: 4px 12px;
            transition: color 0.2s;
        }

        .tab-item.active {
            color: var(--accent-blue);
        }

        .tab-icon {
            font-size: 22px;
        }

        /* ========== ä¼‘æ¯å½ˆçª— ========== */
        .rest-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .rest-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .rest-modal-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .rest-modal-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .rest-modal-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        .rest-modal-timer {
            font-size: 72px;
            font-weight: 200;
            color: var(--accent-cyan);
            font-variant-numeric: tabular-nums;
            margin-bottom: 30px;
        }

        .rest-modal-activity {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 24px;
            background: var(--bg-secondary);
            border-radius: 16px;
            margin-bottom: 30px;
        }

        .rest-modal-activity-icon {
            font-size: 32px;
        }

        .rest-modal-activity-text {
            font-size: 16px;
        }

        /* å‘¼å¸å‹•ç•« */
        .breathing-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--accent-cyan), transparent);
            animation: breathe 4s infinite ease-in-out;
            margin-bottom: 20px;
        }

        @keyframes breathe {
            0%, 100% { transform: scale(0.8); opacity: 0.6; }
            50% { transform: scale(1.2); opacity: 1; }
        }

        .breathing-text {
            font-size: 18px;
            color: var(--accent-cyan);
            margin-bottom: 20px;
        }

        .rest-modal-btn {
            padding: 16px 40px;
            border: none;
            border-radius: 30px;
            background: var(--accent-green);
            color: #000;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .rest-modal-btn:hover {
            transform: scale(1.05);
        }

        /* ========== å…¨è¢å¹•æ¨¡å¼ ========== */
        .fullscreen-mode {
            background: var(--bg-primary) !important;
        }

        .fullscreen-mode .app-container {
            max-width: 100%;
            height: 100vh;
            height: 100dvh; /* iOS Safari å‹•æ…‹è¦–çª—é«˜åº¦ */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0 !important;
        }

        .fullscreen-mode .page {
            display: none !important;
        }

        .fullscreen-mode .page.active {
            display: flex !important;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 0 !important;
        }

        .fullscreen-mode .tab-bar,
        .fullscreen-mode .nav-bar,
        .fullscreen-mode .status-bar,
        .fullscreen-mode .stats-grid,
        .fullscreen-mode .todo-section,
        .fullscreen-mode .ambient-section,
        .fullscreen-mode .rest-activities,
        .fullscreen-mode .mode-switcher,
        .fullscreen-mode .controls,
        .fullscreen-mode .pomodoro-counter {
            display: none !important;
        }

        .fullscreen-mode .timer-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fullscreen-mode .timer-ring {
            width: min(400px, 80vw);
            height: min(400px, 80vw);
            cursor: pointer;
        }

        .fullscreen-mode .timer-display {
            font-size: min(100px, 15vw);
        }

        .fullscreen-mode .timer-emoji {
            font-size: min(60px, 10vw);
        }

        .fullscreen-mode .fullscreen-btn {
            opacity: 0.3;
        }

        .fullscreen-mode .fullscreen-btn:hover {
            opacity: 1;
        }

        .fullscreen-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
        }

        /* ========== Toast ========== */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1001;
            white-space: nowrap;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* ========== å¿«æ·éµæç¤º ========== */
        .shortcuts-hint {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            color: var(--text-tertiary);
            display: none;
        }

        @media (min-width: 768px) {
            .shortcuts-hint {
                display: block;
            }
        }

        /* ========== æ­·å²ç´€éŒ„ ========== */
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            border-bottom: 1px solid var(--separator);
        }

        .history-date {
            font-size: 15px;
            font-weight: 500;
        }

        .history-stats {
            display: flex;
            gap: 16px;
        }

        .history-stat {
            text-align: right;
        }

        .history-stat-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--accent-green);
        }

        .history-stat-label {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        /* ========== éŸ¿æ‡‰å¼ ========== */
        @media (max-width: 380px) {
            .timer-ring {
                width: 240px;
                height: 240px;
            }
            .timer-display {
                font-size: 48px;
            }
            .ambient-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- é–‹æ©Ÿå‹•ç•« -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-container">
            <div class="tech-grid"></div>
            <div class="glow-ring"></div>
            <div class="glow-ring"></div>
            <div class="glow-ring"></div>
            <div class="splash-text">ä¼‘</div>
        </div>
        <div class="splash-subtitle">å°ˆæ³¨å·¥ä½œï¼Œé©æ™‚ä¼‘æ¯</div>
        <div class="splash-version">Pro v5.3.1</div>
    </div>

    <!-- å…¨è¢å¹•æŒ‰éˆ• -->
    <button class="fullscreen-btn" onclick="toggleFullscreen()" title="å…¨è¢å¹•">â›¶</button>

    <!-- ä¸»å®¹å™¨ -->
    <div class="app-container">
        <!-- è¨ˆæ™‚å™¨é  -->
        <div class="page active" id="page-timer">
            <div class="status-bar">
                <span class="status-time" id="statusTime">00:00</span>
                <div class="status-icons">
                    <span id="soundBtn" onclick="toggleSound()">ğŸ””</span>
                    <span>ğŸ“¶</span>
                    <span>ğŸ”‹</span>
                </div>
            </div>

            <div class="nav-bar">
                <div class="nav-title">ç•ªèŒ„é˜</div>
                <div class="nav-actions">
                    <button class="nav-btn" onclick="showShortcuts()" title="å¿«æ·éµ">âŒ¨ï¸</button>
                    <button class="nav-btn" onclick="exportStats()" title="åŒ¯å‡º">ğŸ“¤</button>
                </div>
            </div>

            <!-- æ¨¡å¼åˆ‡æ› -->
            <div class="mode-switcher">
                <button class="mode-btn active" onclick="setMode('countdown')">â±ï¸ å€’æ•¸æ¨¡å¼</button>
                <button class="mode-btn" onclick="setMode('hourly')">ğŸ• æ•´é»æ¨¡å¼</button>
                <button class="mode-btn" onclick="setMode('classroom')">ğŸ« èª²å ‚æ¨¡å¼</button>
            </div>

            <!-- è¨ˆæ™‚å™¨ -->
            <div class="timer-container">
                <div class="timer-ring" onclick="exitFullscreenOnClick()">
                    <svg viewBox="0 0 280 280">
                        <circle class="timer-bg" cx="140" cy="140" r="130"></circle>
                        <circle class="timer-progress" id="timerProgress" cx="140" cy="140" r="130"></circle>
                    </svg>
                    <div class="timer-content">
                        <div class="timer-emoji" id="timerEmoji">ğŸ…</div>
                        <div class="timer-display" id="timerDisplay">25:00</div>
                        <div class="timer-label" id="timerLabel">å·¥ä½œæ™‚é–“</div>
                    </div>
                </div>

                <div class="controls">
                    <button class="control-btn" onclick="resetTimer()" title="é‡ç½®">â†»</button>
                    <button class="start-btn" id="startBtn" onclick="toggleTimer()">
                        <span id="startIcon">â–¶</span>
                        <span class="start-btn-text" id="startText">é–‹å§‹</span>
                    </button>
                    <button class="control-btn" onclick="skipPhase()" title="è·³é">â­</button>
                </div>

                <!-- ç•ªèŒ„è¨ˆæ•¸ï¼ˆé•·ä¼‘æ¯æŒ‡ç¤ºï¼‰ -->
                <div class="pomodoro-count" id="pomodoroCount">
                    <div class="pomodoro-dot"></div>
                    <div class="pomodoro-dot"></div>
                    <div class="pomodoro-dot"></div>
                    <div class="pomodoro-dot"></div>
                </div>
            </div>

            <!-- æ¯æ—¥ç›®æ¨™ -->
            <div class="daily-goal-section" style="padding:0 20px 15px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                    <span style="font-size:13px;color:var(--text-secondary);">ğŸ¯ æ¯æ—¥ç›®æ¨™</span>
                    <span style="font-size:13px;font-weight:600;" id="goalProgress">0/8</span>
                </div>
                <div style="height:8px;background:var(--bg-tertiary);border-radius:4px;overflow:hidden;">
                    <div id="goalProgressBar" style="height:100%;width:0%;background:linear-gradient(90deg,#30d158,#34c759);border-radius:4px;transition:width 0.5s ease;"></div>
                </div>
            </div>

            <!-- çµ±è¨ˆ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="todayCount">0</div>
                    <div class="stat-label">ä»Šæ—¥ç•ªèŒ„</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="todayMinutes">0</div>
                    <div class="stat-label">å°ˆæ³¨åˆ†é˜</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="streakDays">0</div>
                    <div class="stat-label">é€£çºŒå¤©æ•¸</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="bestStreak">0</div>
                    <div class="stat-label">æœ€ä½³ç´€éŒ„</div>
                </div>
            </div>

            <!-- å¾…è¾¦äº‹é … -->
            <div class="todo-section">
                <div class="todo-header">
                    <span class="todo-title">ğŸ“ å¾…è¾¦äº‹é …</span>
                    <button class="todo-add-btn" onclick="toggleTodoInput()">+</button>
                </div>
                <div class="todo-input-container" id="todoInputContainer">
                    <input type="text" class="todo-input" id="todoInput" placeholder="è¼¸å…¥ä»»å‹™åç¨±..." onkeypress="if(event.key==='Enter')addTodo()">
                    <button class="todo-submit" onclick="addTodo()">æ–°å¢</button>
                </div>
                <div class="todo-list" id="todoList">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>

            <!-- ç™½å™ªéŸ³ -->
            <div class="ambient-section">
                <div class="ambient-title">ğŸµ ç™½å™ªéŸ³</div>
                <div class="ambient-grid">
                    <button class="ambient-btn" onclick="toggleAmbient('rain')">
                        ğŸŒ§ï¸<span>é›¨è²</span>
                    </button>
                    <button class="ambient-btn" onclick="toggleAmbient('cafe')">
                        â˜•<span>å’–å•¡å»³</span>
                    </button>
                    <button class="ambient-btn" onclick="toggleAmbient('forest')">
                        ğŸŒ²<span>æ£®æ—</span>
                    </button>
                    <button class="ambient-btn" onclick="toggleAmbient('ocean')">
                        ğŸŒŠ<span>æµ·æµª</span>
                    </button>
                    <button class="ambient-btn" onclick="toggleAmbient('fire')">
                        ğŸ”¥<span>å£çˆ</span>
                    </button>
                    <button class="ambient-btn" onclick="toggleAmbient('wind')">
                        ğŸ’¨<span>å¾®é¢¨</span>
                    </button>
                    <button class="ambient-btn" onclick="toggleAmbient('night')">
                        ğŸŒ™<span>å¤œæ™š</span>
                    </button>
                    <button class="ambient-btn" onclick="toggleAmbient('none')">
                        ğŸ”‡<span>é—œé–‰</span>
                    </button>
                </div>
                <div class="volume-control">
                    <span>ğŸ”ˆ</span>
                    <input type="range" class="volume-slider" id="ambientVolume" min="0" max="100" value="50" onchange="setAmbientVolume(this.value)">
                    <span>ğŸ”Š</span>
                </div>
            </div>

            <!-- ä¼‘æ¯æ´»å‹•æç¤º -->
            <div class="rest-activities">
                <div class="rest-title">ğŸ’¡ ä¼‘æ¯æ™‚å¯ä»¥åš...</div>
                <div class="rest-grid">
                    <div class="rest-item">
                        <div class="rest-item-icon">ğŸš¶</div>
                        <div class="rest-item-text">ç«™èµ·ä¾†èµ°èµ°</div>
                    </div>
                    <div class="rest-item">
                        <div class="rest-item-icon">ğŸ’§</div>
                        <div class="rest-item-text">å–æ¯æ°´</div>
                    </div>
                    <div class="rest-item">
                        <div class="rest-item-icon">ğŸ‘€</div>
                        <div class="rest-item-text">çœ‹çœ‹é æ–¹</div>
                    </div>
                    <div class="rest-item">
                        <div class="rest-item-icon">ğŸ§˜</div>
                        <div class="rest-item-text">ä¼¸å±•å‹•ä½œ</div>
                    </div>
                    <div class="rest-item">
                        <div class="rest-item-icon">ğŸŒ¬ï¸</div>
                        <div class="rest-item-text">æ·±å‘¼å¸</div>
                    </div>
                    <div class="rest-item">
                        <div class="rest-item-icon">â˜•</div>
                        <div class="rest-item-text">æ³¡æ¯èŒ¶</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- çµ±è¨ˆé  -->
        <div class="page" id="page-stats">
            <div class="status-bar">
                <span class="status-time" id="statusTime2">00:00</span>
                <div class="status-icons">ğŸ“¶ ğŸ”‹</div>
            </div>

            <div class="nav-bar">
                <div class="nav-title">çµ±è¨ˆ</div>
            </div>

            <!-- åœ–è¡¨ -->
            <div class="chart-container">
                <div class="chart-header">
                    <span class="chart-title">ğŸ“Š å°ˆæ³¨æ™‚é–“</span>
                    <div class="chart-tabs">
                        <button class="chart-tab active" onclick="setChartView('week')">é€±</button>
                        <button class="chart-tab" onclick="setChartView('month')">æœˆ</button>
                    </div>
                </div>
                <div class="chart-bars" id="chartBars">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>

            <!-- æ­·å²ç´€éŒ„ -->
            <div class="settings-group">
                <div class="settings-header">ğŸ“… æ­·å²ç´€éŒ„</div>
                <div id="historyList">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>

            <!-- ç•ªèŒ„æ£®æ— -->
            <div class="settings-group">
                <div class="settings-header">ğŸŒ³ ç•ªèŒ„æ£®æ—</div>
                <div id="forestContainer" style="background:linear-gradient(180deg,#87ceeb 0%,#98d8c8 50%,#7cb342 100%);border-radius:16px;padding:20px;min-height:120px;display:flex;flex-wrap:wrap;justify-content:center;align-items:flex-end;gap:5px;">
                    <!-- å‹•æ…‹ç”Ÿæˆæ¨¹æœ¨ -->
                </div>
                <div style="text-align:center;padding:10px;color:var(--text-secondary);font-size:12px;">
                    <span id="forestStats">ç´¯è¨ˆ 0 å€‹ç•ªèŒ„ï¼Œç¨®äº† 0 æ£µæ¨¹</span>
                </div>
            </div>

            <!-- æˆå°±ç³»çµ± -->
            <div class="settings-group">
                <div class="settings-header">ğŸ† æˆå°±ï¼ˆ<span id="achievementCount">0</span>/14ï¼‰</div>
                <div id="achievementList" style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>

            <!-- è³‡æ–™åŒ¯å‡º -->
            <div class="settings-group">
                <div class="settings-header">ğŸ’¾ è³‡æ–™ç®¡ç†</div>
                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                    <button onclick="exportData('csv')" style="flex:1;padding:12px;background:var(--bg-tertiary);color:var(--text-primary);border:none;border-radius:10px;font-size:13px;cursor:pointer;">ğŸ“Š åŒ¯å‡º CSV</button>
                    <button onclick="exportData('json')" style="flex:1;padding:12px;background:var(--bg-tertiary);color:var(--text-primary);border:none;border-radius:10px;font-size:13px;cursor:pointer;">ğŸ“ åŒ¯å‡º JSON</button>
                </div>
            </div>
        </div>

        <!-- è¨­å®šé  -->
        <div class="page" id="page-settings">
            <div class="status-bar">
                <span class="status-time" id="statusTime3">00:00</span>
                <div class="status-icons">ğŸ“¶ ğŸ”‹</div>
            </div>

            <div class="nav-bar">
                <div class="nav-title">è¨­å®š</div>
            </div>

            <!-- æ™‚é–“è¨­å®š -->
            <div class="settings-group">
                <div class="settings-header">â±ï¸ æ™‚é–“è¨­å®š</div>
                <div class="setting-item">
                    <div class="setting-left">
                        <div class="setting-icon red">ğŸ…</div>
                        <span class="setting-label">å·¥ä½œæ™‚é–“</span>
                    </div>
                    <div class="setting-value">
                        <input type="number" class="setting-input" id="workDuration" value="25" min="1" max="120">
                        <span>åˆ†é˜</span>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-left">
                        <div class="setting-icon cyan">â˜•</div>
                        <span class="setting-label">çŸ­ä¼‘æ¯</span>
                    </div>
                    <div class="setting-value">
                        <input type="number" class="setting-input" id="shortBreak" value="5" min="1" max="30">
                        <span>åˆ†é˜</span>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-left">
                        <div class="setting-icon purple">ğŸŒ´</div>
                        <span class="setting-label">é•·ä¼‘æ¯</span>
                    </div>
                    <div class="setting-value">
                        <input type="number" class="setting-input" id="longBreak" value="15" min="5" max="60">
                        <span>åˆ†é˜</span>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-left">
                        <div class="setting-icon orange">ğŸ”„</div>
                        <span class="setting-label">é•·ä¼‘æ¯é–“éš”</span>
                    </div>
                    <div class="setting-value">
                        <input type="number" class="setting-input" id="longBreakInterval" value="4" min="2" max="10">
                        <span>å€‹ç•ªèŒ„</span>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-left">
                        <div class="setting-icon blue">ğŸ•</div>
                        <span class="setting-label">æ•´é»æé†’</span>
                    </div>
                    <div class="setting-value">
                        <span>æ¯å°æ™‚</span>
                        <input type="number" class="setting-input" id="hourlyMinute" value="55" min="0" max="59">
                        <span>åˆ†</span>
                    </div>
                </div>
            </div>

            <!-- èª²å ‚æ¨¡å¼è¨­å®š -->
            <div class="settings-group">
                <div class="settings-header">ğŸ« èª²å ‚æ¨¡å¼</div>
                <div class="setting-item">
                    <div class="setting-left">
                        <div class="setting-icon green">ğŸ“š</div>
                        <span class="setting-label">ä¸Šèª²æ™‚é–“</span>
                    </div>
                    <div class="setting-value">
                        <input type="number" class="setting-input" id="classTime" value="45" min="10" max="90">
                        <span>åˆ†é˜</span>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-left">
                        <div class="setting-icon cyan">ğŸ‰</div>
                        <span class="setting-label">ä¸‹èª²æ™‚é–“</span>
                    </div>
                    <div class="setting-value">
                        <input type="number" class="setting-input" id="breakTime" value="10" min="5" max="30">
                        <span>åˆ†é˜</span>
                    </div>
                </div>
            </div>

            <!-- é€šçŸ¥è¨­å®š -->
            <div class="settings-group">
                <div class="settings-header">ğŸ”” é€šçŸ¥è¨­å®š</div>
                <div class="setting-item">
                    <div class="setting-left">
                        <div class="setting-icon blue">ğŸ””</div>
                        <span class="setting-label">ç€è¦½å™¨é€šçŸ¥</span>
                    </div>
                    <div class="ios-switch active" id="switchNotification" onclick="toggleSwitch('notification')"></div>
                </div>
                <div class="setting-item">
                    <div class="setting-left">
                        <div class="setting-icon green">ğŸ”Š</div>
                        <span class="setting-label">éŸ³æ•ˆæé†’</span>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <button onclick="testSound()" style="padding:6px 12px;background:var(--bg-tertiary);color:var(--text-primary);border:none;border-radius:8px;font-size:13px;cursor:pointer;">ğŸ”” æ¸¬è©¦</button>
                        <div class="ios-switch active" id="switchSound" onclick="toggleSwitch('sound')"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-left">
                        <div class="setting-icon purple">ğŸ—£ï¸</div>
                        <span class="setting-label">èªéŸ³æ’­å ±</span>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <button onclick="testSpeech()" style="padding:6px 12px;background:var(--bg-tertiary);color:var(--text-primary);border:none;border-radius:8px;font-size:13px;cursor:pointer;">ğŸ—£ï¸ æ¸¬è©¦</button>
                        <div class="ios-switch" id="switchVoice" onclick="toggleSwitch('voice')"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-left">
                        <div class="setting-icon orange">ğŸ“³</div>
                        <span class="setting-label">éœ‡å‹•æé†’</span>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <button onclick="testVibrate()" style="padding:6px 12px;background:var(--bg-tertiary);color:var(--text-primary);border:none;border-radius:8px;font-size:13px;cursor:pointer;">ğŸ“³ æ¸¬è©¦</button>
                        <div class="ios-switch active" id="switchVibrate" onclick="toggleSwitch('vibrate')"></div>
                    </div>
                </div>
            </div>

            <!-- èªéŸ³æœå‹™è¨­å®š -->
            <div class="settings-group">
                <div class="settings-header">ğŸ™ï¸ èªéŸ³æœå‹™è¨­å®š</div>
                
                <!-- èªéŸ³æœå‹™é¸æ“‡ -->
                <div class="setting-item" style="flex-direction:column;align-items:stretch;gap:10px;">
                    <div class="setting-left">
                        <div class="setting-icon blue">ğŸ”Š</div>
                        <span class="setting-label">èªéŸ³æœå‹™</span>
                    </div>
                    <div style="display:flex;gap:6px;flex-wrap:wrap;">
                        <button class="voice-service-btn active" id="voiceServiceWeb" onclick="setVoiceService('web')" style="flex:1;min-width:80px;padding:10px 8px;border-radius:10px;border:2px solid var(--accent);background:var(--bg-tertiary);color:var(--text-primary);cursor:pointer;">
                            <div style="font-size:18px;">ğŸŒ</div>
                            <div style="font-size:11px;font-weight:600;margin-top:4px;">Web</div>
                            <div style="font-size:9px;color:var(--text-secondary);">å…è²»</div>
                        </button>
                        <button class="voice-service-btn" id="voiceServiceGemini" onclick="setVoiceService('gemini')" style="flex:1;min-width:80px;padding:10px 8px;border-radius:10px;border:2px solid var(--bg-tertiary);background:var(--bg-tertiary);color:var(--text-primary);cursor:pointer;">
                            <div style="font-size:18px;">ğŸ¤–</div>
                            <div style="font-size:11px;font-weight:600;margin-top:4px;">Gemini</div>
                            <div style="font-size:9px;color:var(--text-secondary);">API Key</div>
                        </button>
                        <button class="voice-service-btn" id="voiceServiceElevenLabs" onclick="setVoiceService('elevenlabs')" style="flex:1;min-width:80px;padding:10px 8px;border-radius:10px;border:2px solid var(--bg-tertiary);background:var(--bg-tertiary);color:var(--text-primary);cursor:pointer;">
                            <div style="font-size:18px;">ğŸ­</div>
                            <div style="font-size:11px;font-weight:600;margin-top:4px;">ElevenLabs</div>
                            <div style="font-size:9px;color:var(--text-secondary);">API Key</div>
                        </button>
                    </div>
                </div>

                <!-- è²éŸ³é¸æ“‡ï¼ˆWeb Speech ç”¨ï¼‰-->
                <div class="setting-item" id="webVoiceSection">
                    <div class="setting-left">
                        <div class="setting-icon pink">ğŸ‘¤</div>
                        <span class="setting-label">è²éŸ³é¡å‹</span>
                    </div>
                    <div style="display:flex;gap:8px;">
                        <button class="voice-gender-btn active" id="voiceGenderFemale" onclick="setVoiceGender('female')" style="padding:8px 16px;border-radius:8px;border:2px solid var(--accent);background:var(--bg-tertiary);color:var(--text-primary);cursor:pointer;font-size:13px;">
                            ğŸ‘© å¥³è²
                        </button>
                        <button class="voice-gender-btn" id="voiceGenderMale" onclick="setVoiceGender('male')" style="padding:8px 16px;border-radius:8px;border:2px solid var(--bg-tertiary);background:var(--bg-tertiary);color:var(--text-primary);cursor:pointer;font-size:13px;">
                            ğŸ‘¨ ç”·è²
                        </button>
                    </div>
                </div>

                <!-- Gemini API Key + èªéŸ³é¸æ“‡ -->
                <div class="setting-item" id="geminiKeySection" style="flex-direction:column;align-items:stretch;gap:8px;display:none;">
                    <div class="setting-left">
                        <div class="setting-icon green">ğŸ”‘</div>
                        <span class="setting-label">Gemini API Key</span>
                    </div>
                    <input type="password" class="setting-input" id="geminiApiKey" placeholder="AIza..." style="width:100%;">
                    <div style="font-size:11px;color:var(--text-secondary);">
                        å¾ <a href="https://aistudio.google.com/apikey" target="_blank" style="color:var(--accent);">Google AI Studio</a> å–å¾—
                    </div>
                    <div class="setting-left" style="margin-top:8px;">
                        <div class="setting-icon blue">ğŸ­</div>
                        <span class="setting-label">Gemini èªéŸ³ï¼ˆ30ç¨®ï¼‰</span>
                    </div>
                    <select id="geminiVoice" class="setting-input" style="width:100%;padding:10px;border-radius:8px;background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--bg-tertiary);">
                        <optgroup label="â­ æ¨è–¦">
                            <option value="Zephyr">Zephyrï¼ˆå¥³ï¼Œæº«æŸ”ï¼‰</option>
                            <option value="Puck">Puckï¼ˆç”·ï¼Œæ´»æ½‘ï¼‰</option>
                            <option value="Kore">Koreï¼ˆå¥³ï¼Œæ¸…æ–°ï¼‰</option>
                            <option value="Charon">Charonï¼ˆç”·ï¼Œæ²‰ç©©ï¼‰</option>
                            <option value="Aoede">Aoedeï¼ˆå¥³ï¼Œå„ªé›…ï¼‰</option>
                        </optgroup>
                        <optgroup label="ğŸ‘© å¥³è²">
                            <option value="Leda">Leda</option>
                            <option value="Callirrhoe">Callirrhoe</option>
                            <option value="Autonoe">Autonoe</option>
                            <option value="Despina">Despina</option>
                            <option value="Erinome">Erinome</option>
                            <option value="Laomedeia">Laomedeia</option>
                            <option value="Pulcherrima">Pulcherrima</option>
                        </optgroup>
                        <optgroup label="ğŸ‘¨ ç”·è²">
                            <option value="Orus">Orus</option>
                            <option value="Fenrir">Fenrir</option>
                            <option value="Enceladus">Enceladus</option>
                            <option value="Iapetus">Iapetus</option>
                            <option value="Umbriel">Umbriel</option>
                            <option value="Algieba">Algieba</option>
                            <option value="Algenib">Algenib</option>
                            <option value="Rasalgethi">Rasalgethi</option>
                        </optgroup>
                        <optgroup label="ğŸŒŸ å…¶ä»–">
                            <option value="Achernar">Achernar</option>
                            <option value="Alnilam">Alnilam</option>
                            <option value="Schedar">Schedar</option>
                            <option value="Gacrux">Gacrux</option>
                            <option value="Achird">Achird</option>
                            <option value="Zubenelgenubi">Zubenelgenubi</option>
                            <option value="Vindemiatrix">Vindemiatrix</option>
                            <option value="Sadachbia">Sadachbia</option>
                            <option value="Sadaltager">Sadaltager</option>
                            <option value="Sulafat">Sulafat</option>
                        </optgroup>
                    </select>
                </div>

                <!-- ElevenLabs API Key + èªéŸ³é¸æ“‡ -->
                <div class="setting-item" id="elevenlabsKeySection" style="flex-direction:column;align-items:stretch;gap:8px;display:none;">
                    <div class="setting-left">
                        <div class="setting-icon purple">ğŸ”‘</div>
                        <span class="setting-label">ElevenLabs API Key</span>
                    </div>
                    <input type="password" class="setting-input" id="elevenlabsApiKey" placeholder="sk_..." style="width:100%;">
                    <div style="font-size:11px;color:var(--text-secondary);">
                        å¾ <a href="https://elevenlabs.io/api" target="_blank" style="color:var(--accent);">ElevenLabs</a> å–å¾—
                    </div>
                    <div class="setting-left" style="margin-top:8px;">
                        <div class="setting-icon pink">ğŸ­</div>
                        <span class="setting-label">ElevenLabs èªéŸ³</span>
                    </div>
                    <select id="elevenlabsVoice" class="setting-input" style="width:100%;padding:10px;border-radius:8px;background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--bg-tertiary);">
                        <optgroup label="ğŸ‘© å¥³è²">
                            <option value="21m00Tcm4TlvDq8ikWAM">Rachelï¼ˆæº«æš–è‡ªç„¶ï¼‰</option>
                            <option value="EXAVITQu4vr4xnSDxMaL">Bellaï¼ˆæŸ”å’Œç”œç¾ï¼‰</option>
                            <option value="AZnzlk1XvdvUeBnXmlld">Domiï¼ˆæ´»æ½‘å¹´è¼•ï¼‰</option>
                            <option value="MF3mGyEYCl7XYWbV9V6O">Elliï¼ˆæ¸…æ™°å°ˆæ¥­ï¼‰</option>
                            <option value="piTKgcLEGmPE4e6mEKli">Nicoleï¼ˆå„ªé›…æˆç†Ÿï¼‰</option>
                            <option value="z9fAnlkpzviPz146aGWa">Glindaï¼ˆæ˜äº®å‹å–„ï¼‰</option>
                            <option value="jBpfuIE2acCO8z3wKNLl">Gigiï¼ˆå¹´è¼•æ´»åŠ›ï¼‰</option>
                            <option value="oWAxZDx7w5VEj9dCyTzz">Graceï¼ˆæ²‰ç©©çŸ¥æ€§ï¼‰</option>
                        </optgroup>
                        <optgroup label="ğŸ‘¨ ç”·è²">
                            <option value="pNInz6obpgDQGcFmaJgB">Adamï¼ˆæ·±æ²‰ç©©é‡ï¼‰</option>
                            <option value="ErXwobaYiN019PkySvjV">Antoniï¼ˆæº«æš–è¦ªåˆ‡ï¼‰</option>
                            <option value="TxGEqnHWrfWFTfGW9XjX">Joshï¼ˆå¹´è¼•é™½å…‰ï¼‰</option>
                            <option value="yoZ06aMxZJJ28mfd3POQ">Samï¼ˆæˆç†Ÿå°ˆæ¥­ï¼‰</option>
                            <option value="VR6AewLTigWG4xSOukaG">Arnoldï¼ˆæ¸¾åšæœ‰åŠ›ï¼‰</option>
                            <option value="pqHfZKP75CvOlQylNhV4">Billï¼ˆæ²‰ç©©å¯é ï¼‰</option>
                            <option value="nPczCjzI2devNBz1zQrb">Brianï¼ˆå‹å–„ç†±æƒ…ï¼‰</option>
                            <option value="N2lVS1w4EtoT3dr4eOWO">Callumï¼ˆè‹±å¼ç´³å£«ï¼‰</option>
                        </optgroup>
                        <optgroup label="ğŸŒŸ ç‰¹è‰²">
                            <option value="XB0fDUnXU5powFXDhCwa">Charlotteï¼ˆè‹±å¼å„ªé›…ï¼‰</option>
                            <option value="Xb7hH8MSUJpSbSDYk0k2">Aliceï¼ˆè‹±å¼æ¸…æ–°ï¼‰</option>
                            <option value="iP95p4xoKVk53GoZ742B">Chrisï¼ˆç¾å¼æ’­å ±ï¼‰</option>
                            <option value="onwK4e9ZLuTAKqWW03F9">Danielï¼ˆè‹±å¼æ²‰ç©©ï¼‰</option>
                        </optgroup>
                    </select>
                </div>

                <!-- æ¸¬è©¦èˆ‡å„²å­˜ -->
                <div class="setting-item" style="gap:8px;">
                    <button onclick="saveVoiceSettings()" style="flex:1;padding:10px;background:var(--accent-blue);color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;">ğŸ’¾ å„²å­˜</button>
                    <button onclick="testVoiceService()" style="flex:1;padding:10px;background:var(--accent-green);color:#000;border:none;border-radius:8px;font-weight:600;cursor:pointer;">ğŸ™ï¸ æ¸¬è©¦èªéŸ³</button>
                </div>
            </div>

            <!-- æ¯æ—¥ç›®æ¨™ -->
            <div class="settings-group">
                <div class="settings-header">ğŸ¯ æ¯æ—¥ç›®æ¨™</div>
                <div class="setting-item">
                    <div class="setting-left">
                        <div class="setting-icon green">ğŸ…</div>
                        <span class="setting-label">ç›®æ¨™ç•ªèŒ„æ•¸</span>
                    </div>
                    <div class="setting-value">
                        <input type="number" class="setting-input" id="dailyGoal" value="8" min="1" max="30" onchange="saveDailyGoal()">
                        <span>å€‹</span>
                    </div>
                </div>
            </div>

            <!-- åŸ·è¡Œæ¨¡å¼ -->
            <div class="settings-group">
                <div class="settings-header">ğŸ“± åŸ·è¡Œæ¨¡å¼</div>
                <div class="setting-item" style="flex-direction:column;align-items:flex-start;gap:12px;">
                    <div style="font-size:12px;color:var(--text-secondary);line-height:1.5;">
                        é¸æ“‡è¨ˆæ™‚æ™‚çš„è¢å¹•è¡Œç‚ºï¼š
                    </div>
                    <div class="screen-mode-selector" style="display:flex;gap:8px;width:100%;">
                        <button class="screen-mode-btn active" id="modeBackground" onclick="setScreenMode('background')" style="flex:1;padding:12px;border-radius:12px;border:2px solid var(--accent);background:var(--bg-tertiary);color:var(--text-primary);cursor:pointer;">
                            <div style="font-size:20px;margin-bottom:4px;">ğŸŒ™</div>
                            <div style="font-size:13px;font-weight:600;">èƒŒæ™¯åŸ·è¡Œ</div>
                            <div style="font-size:11px;color:var(--text-secondary);margin-top:4px;">çœé›»ï¼Œä½†å–šé†’å¾Œ<br>éŸ³æ•ˆå¯èƒ½å»¶é²</div>
                        </button>
                        <button class="screen-mode-btn" id="modeAwake" onclick="setScreenMode('awake')" style="flex:1;padding:12px;border-radius:12px;border:2px solid var(--bg-tertiary);background:var(--bg-tertiary);color:var(--text-primary);cursor:pointer;">
                            <div style="font-size:20px;margin-bottom:4px;">â˜€ï¸</div>
                            <div style="font-size:13px;font-weight:600;">è¢å¹•é•·äº®</div>
                            <div style="font-size:11px;color:var(--text-secondary);margin-top:4px;">è€—é›»ï¼Œä½†éŸ³æ•ˆ<br>100% æº–æ™‚éŸ¿èµ·</div>
                        </button>
                    </div>
                    <div id="wakeLockStatus" style="font-size:11px;color:var(--text-tertiary);text-align:center;width:100%;display:none;">
                        ğŸ”“ è¢å¹•é•·äº®å·²å•Ÿç”¨
                    </div>
                </div>
            </div>

            <!-- é˜è²é¸æ“‡ -->
            <div class="settings-group">
                <div class="settings-header">ğŸµ æé†’éŸ³æ•ˆï¼ˆ30 ç¨®ï¼‰</div>
                <div class="chime-selector" id="chimeSelector">
                    <!-- åŸå‰µéŸ³æ•ˆ -->
                    <button class="chime-option active" onclick="setChime('westminster')">ğŸ”” è¥¿æ•å¯º</button>
                    <button class="chime-option" onclick="setChime('school')">ğŸ« å‚³çµ±é˜è²</button>
                    <button class="chime-option" onclick="setChime('digital')">ğŸ“± æ•¸ä½éŸ³</button>
                    <button class="chime-option" onclick="setChime('gentle')">ğŸ è¼•æŸ”éˆ´è²</button>
                    <button class="chime-option" onclick="setChime('bird')">ğŸ¦ é³¥é³´</button>
                    <!-- å°æ£®å¹³æ´»å‹•éŸ³æ•ˆ -->
                    <button class="chime-option" onclick="setChime('clap')">ğŸ‘ æŒè²</button>
                    <button class="chime-option" onclick="setChime('cheers')">ğŸ‰ æ­¡å‘¼</button>
                    <button class="chime-option" onclick="setChime('cracker')">ğŸŠ éŸ¿ç ²</button>
                    <button class="chime-option" onclick="setChime('buzzer')">ğŸ“¢ èœ‚é³´å™¨</button>
                    <button class="chime-option" onclick="setChime('firework')">ğŸ† ç…™ç«</button>
                    <!-- å°æ£®å¹³éŠæˆ²éŸ³æ•ˆ -->
                    <button class="chime-option" onclick="setChime('powerup1')">â¬†ï¸ å‡ç´š1</button>
                    <button class="chime-option" onclick="setChime('powerup2')">â¬†ï¸ å‡ç´š2</button>
                    <button class="chime-option" onclick="setChime('powerup3')">â¬†ï¸ å‡ç´š3</button>
                    <button class="chime-option" onclick="setChime('powerdown1')">â¬‡ï¸ é™ç´š</button>
                    <button class="chime-option" onclick="setChime('coin1')">ğŸª™ é‡‘å¹£1</button>
                    <button class="chime-option" onclick="setChime('coin2')">ğŸª™ é‡‘å¹£2</button>
                    <button class="chime-option" onclick="setChime('coin3')">ğŸª™ é‡‘å¹£3</button>
                    <button class="chime-option" onclick="setChime('button1')">ğŸ”˜ æŒ‰éˆ•1</button>
                    <button class="chime-option" onclick="setChime('button2')">ğŸ”˜ æŒ‰éˆ•2</button>
                    <button class="chime-option" onclick="setChime('select1')">ğŸ‘† é¸æ“‡1</button>
                    <button class="chime-option" onclick="setChime('select2')">ğŸ‘† é¸æ“‡2</button>
                    <button class="chime-option" onclick="setChime('jump1')">ğŸ¦˜ è·³èº1</button>
                    <button class="chime-option" onclick="setChime('jump2')">ğŸ¦˜ è·³èº2</button>
                    <button class="chime-option" onclick="setChime('cat1')">ğŸ± è²“å’ª1</button>
                    <button class="chime-option" onclick="setChime('cat2')">ğŸ± è²“å’ª2</button>
                    <button class="chime-option" onclick="setChime('blip1')">ğŸ“Ÿ å—¶å—¶1</button>
                    <button class="chime-option" onclick="setChime('blip2')">ğŸ“Ÿ å—¶å—¶2</button>
                    <!-- å°æ£®å¹³æ¨‚å™¨ -->
                    <button class="chime-option" onclick="setChime('piano')">ğŸ¹ å°æ˜Ÿæ˜Ÿ</button>
                    <button class="chime-option" onclick="setChime('wadaiko')">ğŸ¥ å¤ªé¼“</button>
                    <button class="chime-option" onclick="setChime('pickup1')">âœ¨ æ’¿å–</button>
                </div>
            </div>

            <!-- ä¸»é¡Œè¨­å®š -->
            <div class="settings-group">
                <div class="settings-header">ğŸ¨ ä¸»é¡Œ</div>
                <div class="theme-selector">
                    <div class="theme-option dark active" onclick="setTheme('dark')" title="æ·±è‰²"></div>
                    <div class="theme-option light" onclick="setTheme('light')" title="æ·ºè‰²"></div>
                    <div class="theme-option forest" onclick="setTheme('forest')" title="æ£®æ—"></div>
                    <div class="theme-option ocean" onclick="setTheme('ocean')" title="æµ·æ´‹"></div>
                </div>
            </div>

            <!-- ä¼‘çœ è¨­å®š -->
            <div class="settings-group">
                <div class="settings-header">ğŸŒ™ ä¼‘çœ è¨­å®š</div>
                <div class="setting-item">
                    <div class="setting-left">
                        <div class="setting-icon purple">ğŸŒ™</div>
                        <span class="setting-label">ä¼‘çœ é–‹å§‹</span>
                    </div>
                    <input type="time" class="setting-input" id="sleepStart" value="00:00" style="width:100px;">
                </div>
                <div class="setting-item">
                    <div class="setting-left">
                        <div class="setting-icon cyan">ğŸŒ…</div>
                        <span class="setting-label">ä¼‘çœ çµæŸ</span>
                    </div>
                    <input type="time" class="setting-input" id="sleepEnd" value="06:00" style="width:100px;">
                </div>
                <div class="setting-item">
                    <div class="setting-left">
                        <div class="setting-icon purple">ğŸ˜´</div>
                        <span class="setting-label">ç¡çœ æé†’</span>
                    </div>
                    <input type="time" class="setting-input" id="sleepReminder" value="21:45" style="width:100px;">
                </div>
            </div>

            <!-- GAS è¨­å®š -->
            <div class="settings-group">
                <div class="settings-header">ğŸ“¡ LINE é€šçŸ¥ï¼ˆä¼ºæœå™¨ç«¯è¨ˆæ™‚ï¼‰</div>
                <div style="padding:0 15px 10px;font-size:12px;color:var(--text-secondary);line-height:1.5;">
                    âš¡ å³ä½¿æ‰‹æ©Ÿä¼‘çœ ï¼ŒGAS ä¹Ÿæœƒåœ¨æ™‚é–“åˆ°æ™‚ç™¼é€ LINE é€šçŸ¥å–šé†’ä½ ï¼
                </div>
                <div class="setting-item" style="flex-direction:column;align-items:stretch;gap:8px;">
                    <div class="setting-left">
                        <div class="setting-icon purple">ğŸŒ</div>
                        <span class="setting-label">GAS Web App URL</span>
                    </div>
                    <input type="text" class="setting-input" id="gasUrl" placeholder="https://script.google.com/..." style="width:100%;">
                    <div style="display:flex;gap:8px;">
                        <button onclick="saveGasUrl()" style="flex:1;padding:10px;background:var(--accent-blue);color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;">ğŸ’¾ å„²å­˜</button>
                        <button onclick="testGas()" style="flex:1;padding:10px;background:var(--accent-green);color:#000;border:none;border-radius:8px;font-weight:600;cursor:pointer;">ğŸ“¤ æ¸¬è©¦ LINE</button>
                    </div>
                </div>
            </div>

            <!-- æ“ä½œ -->
            <div class="settings-group">
                <div class="setting-item">
                    <button onclick="saveAllSettings()" style="width:100%;padding:14px;background:var(--accent-blue);color:#fff;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;">
                        ğŸ’¾ å„²å­˜æ‰€æœ‰è¨­å®š
                    </button>
                </div>
                <div class="setting-item">
                    <button onclick="testRestCountdown()" style="width:100%;padding:14px;background:var(--accent-orange);color:#000;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;">
                        â±ï¸ æ¸¬è©¦ä¼‘æ¯å€’æ•¸ï¼ˆ10 ç§’ï¼‰
                    </button>
                </div>
                <div class="setting-item">
                    <button onclick="clearAllData()" style="width:100%;padding:14px;background:var(--accent-red);color:#fff;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;">
                        ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™
                    </button>
                </div>
            </div>

            <!-- é—œæ–¼ -->
            <div class="settings-group">
                <div class="settings-header">â„¹ï¸ é—œæ–¼</div>
                <div class="setting-item">
                    <span>ç‰ˆæœ¬</span>
                    <span style="color:var(--text-secondary);">Pro v5.3.1</span>
                </div>
                <div class="setting-item">
                    <span>å¿«æ·éµ</span>
                    <span style="color:var(--text-secondary);">Space/R/F/M</span>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨å°èˆª -->
        <div class="tab-bar">
            <button class="tab-item active" onclick="switchPage('timer')">
                <span class="tab-icon">â±ï¸</span>
                <span>è¨ˆæ™‚å™¨</span>
            </button>
            <button class="tab-item" onclick="switchPage('stats')">
                <span class="tab-icon">ğŸ“Š</span>
                <span>çµ±è¨ˆ</span>
            </button>
            <button class="tab-item" onclick="switchPage('settings')">
                <span class="tab-icon">âš™ï¸</span>
                <span>è¨­å®š</span>
            </button>
        </div>
    </div>

    <!-- ä¼‘æ¯å½ˆçª— -->
    <div class="rest-modal" id="restModal">
        <div class="rest-modal-icon" id="restModalIcon">â˜•</div>
        <div class="rest-modal-title" id="restModalTitle">ä¼‘æ¯æ™‚é–“åˆ°ï¼</div>
        <div class="rest-modal-subtitle">ç«™èµ·ä¾†æ´»å‹•ä¸€ä¸‹å§</div>
        <div class="breathing-circle" id="breathingCircle"></div>
        <div class="breathing-text" id="breathingText">æ·±å‘¼å¸...</div>
        <div class="rest-modal-timer" id="restModalTimer">5:00</div>
        <div class="rest-modal-activity" id="restActivity">
            <div class="rest-modal-activity-icon">ğŸš¶</div>
            <div class="rest-modal-activity-text">ç«™èµ·ä¾†èµ°èµ°</div>
        </div>
        <button class="rest-modal-btn" onclick="endRest()">çµæŸä¼‘æ¯ï¼Œç¹¼çºŒå·¥ä½œ</button>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- å¿«æ·éµæç¤º -->
    <div class="shortcuts-hint">
        âŒ¨ï¸ Space: é–‹å§‹/æš«åœ | R: é‡ç½® | F: å…¨è¢å¹• | M: éœéŸ³
    </div>

    <script>
        // ============================================
        // ç‹€æ…‹ç®¡ç†
        // ============================================
        let settings = {
            workDuration: 25,
            shortBreak: 5,
            longBreak: 15,
            longBreakInterval: 4,
            hourlyMinute: 55,
            classTime: 45,
            breakTime: 10,
            sleepStart: '00:00',
            sleepEnd: '06:00',
            sleepReminder: '21:45',
            notification: true,
            sound: true,
            voice: false,
            vibrate: true,
            chime: 'westminster',
            theme: 'dark',
            gasUrl: '',
            screenMode: 'background',
            dailyGoal: 8,
            // èªéŸ³æœå‹™è¨­å®š
            voiceService: 'web',        // 'web' | 'gemini' | 'elevenlabs'
            voiceGender: 'female',      // 'male' | 'female' (Web Speech ç”¨)
            geminiApiKey: '',
            geminiVoice: 'Zephyr',      // Gemini èªéŸ³åç¨±
            elevenlabsApiKey: '',
            elevenlabsVoice: '21m00Tcm4TlvDq8ikWAM'  // ElevenLabs èªéŸ³ ID (Rachel)
        };

        let timerState = {
            mode: 'countdown', // countdown | hourly | classroom
            phase: 'work', // work | rest | longRest
            isRunning: false,
            timeLeft: 25 * 60,
            totalTime: 25 * 60,
            pomodoroCount: 0, // ç•¶å‰é€±æœŸçš„ç•ªèŒ„æ•¸
            sessionCount: 0,  // ä»Šæ—¥ç¸½ç•ªèŒ„æ•¸
            endTime: null     // è¨ˆæ™‚çµæŸçš„æ™‚é–“æˆ³ï¼ˆç”¨æ–¼èƒŒæ™¯è¨ˆæ™‚ï¼‰
        };

        let stats = {
            todayCount: 0,
            todayMinutes: 0,
            streak: 0,
            bestStreak: 0,
            lastDate: null,
            history: [],
            weeklyData: [0, 0, 0, 0, 0, 0, 0],
            totalPomodoros: 0,       // æ­·å²ç¸½ç•ªèŒ„æ•¸
            totalMinutes: 0,         // æ­·å²ç¸½åˆ†é˜æ•¸
            forest: [],              // ç•ªèŒ„æ£®æ—ï¼š[{date, count, trees:[]}]
            achievements: []         // å·²è§£é–æˆå°±
        };

        // æˆå°±å®šç¾©
        const ACHIEVEMENTS = [
            { id: 'first', icon: 'ğŸŒ±', name: 'åˆæ¬¡èŒèŠ½', desc: 'å®Œæˆç¬¬ä¸€å€‹ç•ªèŒ„', condition: s => s.totalPomodoros >= 1 },
            { id: 'ten', icon: 'ğŸŒ¿', name: 'å°æœ‰æˆå°±', desc: 'ç´¯è¨ˆå®Œæˆ 10 å€‹ç•ªèŒ„', condition: s => s.totalPomodoros >= 10 },
            { id: 'fifty', icon: 'ğŸŒ³', name: 'èŒå£¯æˆé•·', desc: 'ç´¯è¨ˆå®Œæˆ 50 å€‹ç•ªèŒ„', condition: s => s.totalPomodoros >= 50 },
            { id: 'hundred', icon: 'ğŸ†', name: 'ç•ªèŒ„å¤§å¸«', desc: 'ç´¯è¨ˆå®Œæˆ 100 å€‹ç•ªèŒ„', condition: s => s.totalPomodoros >= 100 },
            { id: 'fiveHundred', icon: 'ğŸ‘‘', name: 'å°ˆæ³¨ç‹è€…', desc: 'ç´¯è¨ˆå®Œæˆ 500 å€‹ç•ªèŒ„', condition: s => s.totalPomodoros >= 500 },
            { id: 'streak3', icon: 'ğŸ”¥', name: 'ä¸‰æ—¥é€£å‹', desc: 'é€£çºŒ 3 å¤©å®Œæˆç•ªèŒ„', condition: s => s.streak >= 3 },
            { id: 'streak7', icon: 'ğŸ’ª', name: 'é€±å† è»', desc: 'é€£çºŒ 7 å¤©å®Œæˆç•ªèŒ„', condition: s => s.streak >= 7 },
            { id: 'streak30', icon: 'â­', name: 'æœˆåº¦ä¹‹æ˜Ÿ', desc: 'é€£çºŒ 30 å¤©å®Œæˆç•ªèŒ„', condition: s => s.streak >= 30 },
            { id: 'daily4', icon: 'ğŸ¯', name: 'åŠæ—¥é”æ¨™', desc: 'å–®æ—¥å®Œæˆ 4 å€‹ç•ªèŒ„', condition: s => s.todayCount >= 4 },
            { id: 'daily8', icon: 'ğŸ–ï¸', name: 'å…¨æ—¥é”æ¨™', desc: 'å–®æ—¥å®Œæˆ 8 å€‹ç•ªèŒ„', condition: s => s.todayCount >= 8 },
            { id: 'daily12', icon: 'ğŸ…', name: 'è¶…ç´šå°ˆæ³¨', desc: 'å–®æ—¥å®Œæˆ 12 å€‹ç•ªèŒ„', condition: s => s.todayCount >= 12 },
            { id: 'hour5', icon: 'â°', name: 'äº”å°æ™‚é”äºº', desc: 'å–®æ—¥å°ˆæ³¨è¶…é 5 å°æ™‚', condition: s => s.todayMinutes >= 300 },
            { id: 'earlyBird', icon: 'ğŸŒ…', name: 'æ—©èµ·é³¥å…’', desc: 'æ—©ä¸Š 6 é»å‰å®Œæˆç•ªèŒ„', condition: () => new Date().getHours() < 6 },
            { id: 'nightOwl', icon: 'ğŸ¦‰', name: 'å¤œè²“å­', desc: 'æ™šä¸Š 11 é»å¾Œå®Œæˆç•ªèŒ„', condition: () => new Date().getHours() >= 23 }
        ];

        // æ¨¹æœ¨é¡å‹ï¼ˆæ ¹æ“šç•¶æ—¥å®Œæˆæ•¸é‡ï¼‰
        const TREE_TYPES = [
            { min: 1, icon: 'ğŸŒ±', name: 'å¹¼è‹—' },
            { min: 2, icon: 'ğŸŒ¿', name: 'å°è‰' },
            { min: 4, icon: 'ğŸª´', name: 'ç›†æ ½' },
            { min: 6, icon: 'ğŸŒ²', name: 'æ¾æ¨¹' },
            { min: 8, icon: 'ğŸŒ³', name: 'å¤§æ¨¹' },
            { min: 10, icon: 'ğŸ„', name: 'è–èª•æ¨¹' },
            { min: 12, icon: 'ğŸŒ´', name: 'æ£•æ«šæ¨¹' },
            { min: 15, icon: 'ğŸ’', name: 'èŠ±æŸ' },
            { min: 20, icon: 'ğŸµï¸', name: 'é‡‘èŠ±' }
        ];

        let todos = [];
        let activeTodoIndex = -1;

        let timerInterval = null;
        let hourlyCheckInterval = null;
        let lastHourlyReminder = null;
        let breathingInterval = null;

        // ç™½å™ªéŸ³
        let ambientAudio = null;
        let ambientGainNode = null;
        let currentAmbient = 'none';

        // éŸ³æ•ˆ
        let audioContext = null;

        const restActivities = [
            { icon: 'ğŸš¶', text: 'ç«™èµ·ä¾†èµ°èµ°' },
            { icon: 'ğŸ’§', text: 'å–æ¯æ°´è£œå……æ°´åˆ†' },
            { icon: 'ğŸ‘€', text: 'çœ‹çœ‹çª—å¤–é æ–¹' },
            { icon: 'ğŸ§˜', text: 'åšå¹¾å€‹ä¼¸å±•å‹•ä½œ' },
            { icon: 'ğŸŒ¬ï¸', text: 'æ·±å‘¼å¸æ”¾é¬†' },
            { icon: 'â˜•', text: 'æ³¡æ¯èŒ¶æˆ–å’–å•¡' }
        ];

        // ============================================
        // åˆå§‹åŒ–
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // é–‹æ©Ÿå‹•ç•«
            setTimeout(() => {
                document.getElementById('splashScreen').classList.add('fade-out');
                setTimeout(() => {
                    document.getElementById('splashScreen').style.display = 'none';
                }, 800);
            }, 2000);

            // è¼‰å…¥è¨­å®šå’Œçµ±è¨ˆ
            loadSettings();
            loadStats();
            loadTodos();
            
            // æ¢å¾©è¨ˆæ™‚ç‹€æ…‹ï¼ˆå¦‚æœæœ‰ï¼‰
            loadTimerState();

            // æ›´æ–°ç‹€æ…‹åˆ—æ™‚é–“
            updateStatusTime();
            setInterval(updateStatusTime, 1000);

            // æ›´æ–°é¡¯ç¤º
            updateTimerDisplay();
            updateStatsDisplay();
            updateTodoList();
            updateChart();
            updatePomodoroCount();
            updateForest();
            updateAchievementList();
            updateGoalProgress();

            // å•Ÿå‹•æ•´é»æª¢æŸ¥
            startHourlyCheck();

            // è«‹æ±‚é€šçŸ¥æ¬Šé™
            requestNotificationPermission();

            // åˆå§‹åŒ–éŸ³æ•ˆ
            initAudio();
            
            // åˆå§‹åŒ–èªéŸ³å¼•æ“
            initSpeech();

            // ç¶å®šéµç›¤å¿«æ·éµ
            bindKeyboardShortcuts();
        });

        // ============================================
        // é é¢åˆ‡æ›
        // ============================================
        function switchPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            
            document.getElementById('page-' + page).classList.add('active');
            
            // æ‰¾åˆ°å°æ‡‰çš„ tab ä¸¦åŠ ä¸Š active
            document.querySelectorAll('.tab-item').forEach(t => {
                if (t.getAttribute('onclick').includes(`'${page}'`)) {
                    t.classList.add('active');
                }
            });

            if (page === 'stats') {
                updateChart();
                updateHistoryList();
                updateForest();
                updateAchievementList();
            }
        }

        // ============================================
        // æ¨¡å¼åˆ‡æ›
        // ============================================
        function setMode(mode) {
            timerState.mode = mode;
            timerState.phase = 'work';
            timerState.isRunning = false;
            clearInterval(timerInterval);

            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            
            // æ‰¾åˆ°å°æ‡‰çš„æŒ‰éˆ•ä¸¦åŠ ä¸Š active
            document.querySelectorAll('.mode-btn').forEach(btn => {
                if (btn.getAttribute('onclick').includes(`'${mode}'`)) {
                    btn.classList.add('active');
                }
            });

            if (mode === 'countdown') {
                timerState.timeLeft = settings.workDuration * 60;
                timerState.totalTime = settings.workDuration * 60;
            } else if (mode === 'classroom') {
                timerState.timeLeft = settings.classTime * 60;
                timerState.totalTime = settings.classTime * 60;
                document.getElementById('timerLabel').textContent = 'ä¸Šèª²æ™‚é–“';
                document.getElementById('timerEmoji').textContent = 'ğŸ“š';
            } else {
                updateHourlyDisplay();
            }

            updateTimerDisplay();
            updateTimerStyle();
            updateStartButton();
        }

        // ============================================
        // è¨ˆæ™‚å™¨æ§åˆ¶
        // ============================================
        function toggleTimer() {
            if (timerState.mode === 'hourly') {
                showToast('æ•´é»æ¨¡å¼æœƒè‡ªå‹•æé†’');
                return;
            }

            if (timerState.isRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        }

        function startTimer() {
            timerState.isRunning = true;
            timerState.endTime = Date.now() + timerState.timeLeft * 1000;
            updateStartButton();
            
            // ğŸ—£ï¸ ç”¨æˆ¶äº’å‹•æ™‚åˆå§‹åŒ–èªéŸ³å¼•æ“ï¼ˆiOS éœ€è¦ï¼‰
            initSpeechOnUserAction();
            
            // è¢å¹•é•·äº®æ¨¡å¼
            handleWakeLockOnTimerStart();
            
            // ğŸ”” ç™¼é€åˆ° GAS ä¼ºæœå™¨ç«¯è¨ˆæ™‚ï¼ˆå³ä½¿ä¼‘çœ ä¹Ÿæœƒé€šçŸ¥ï¼‰
            sendTimerToGAS('work', Math.ceil(timerState.timeLeft / 60));

            timerInterval = setInterval(() => {
                // ç”¨æ™‚é–“æˆ³è¨ˆç®—å‰©é¤˜æ™‚é–“ï¼Œé¿å…èƒŒæ™¯ç¯€æµå•é¡Œ
                const now = Date.now();
                const remaining = Math.max(0, Math.ceil((timerState.endTime - now) / 1000));
                timerState.timeLeft = remaining;
                updateTimerDisplay();

                if (timerState.timeLeft <= 0) {
                    handleTimerComplete();
                }
            }, 1000);
        }
        
        // ç”¨æˆ¶äº’å‹•æ™‚åˆå§‹åŒ–èªéŸ³å¼•æ“ï¼ˆè§£æ±º iOS Safari é™åˆ¶ï¼‰
        function initSpeechOnUserAction() {
            if (!('speechSynthesis' in window)) return;
            
            try {
                console.log('ğŸ—£ï¸ åˆå§‹åŒ–èªéŸ³å¼•æ“');
                
                // å–æ¶ˆä¹‹å‰çš„èªéŸ³
                speechSynthesis.cancel();
                
                // æ’­æ”¾ä¸€å€‹ç©ºç™½èªéŸ³ä¾†è§£é–
                const unlock = new SpeechSynthesisUtterance('');
                unlock.volume = 0;
                speechSynthesis.speak(unlock);
                
                // é è¼‰èªéŸ³åˆ—è¡¨
                speechSynthesis.getVoices();
                
                console.log('ğŸ—£ï¸ èªéŸ³å¼•æ“å·²åˆå§‹åŒ–');
            } catch (e) {
                console.log('ğŸ—£ï¸ èªéŸ³å¼•æ“åˆå§‹åŒ–å¤±æ•—:', e);
            }
        }

        function pauseTimer() {
            timerState.isRunning = false;
            timerState.endTime = null;
            clearInterval(timerInterval);
            updateStartButton();
            
            // æš«åœæ™‚é‡‹æ”¾ Wake Lock
            handleWakeLockOnTimerStop();
            
            // å–æ¶ˆ GAS ä¼ºæœå™¨ç«¯è¨ˆæ™‚
            cancelGASTimer();
        }

        function resetTimer() {
            clearInterval(timerInterval);
            timerState.isRunning = false;
            timerState.phase = 'work';
            timerState.endTime = null;

            if (timerState.mode === 'countdown') {
                timerState.timeLeft = settings.workDuration * 60;
                timerState.totalTime = settings.workDuration * 60;
            } else if (timerState.mode === 'classroom') {
                timerState.timeLeft = settings.classTime * 60;
                timerState.totalTime = settings.classTime * 60;
            }

            updateTimerDisplay();
            updateTimerStyle();
            updateStartButton();
            showToast('â±ï¸ è¨ˆæ™‚å™¨å·²é‡ç½®');
        }

        function skipPhase() {
            handleTimerComplete();
        }

        function handleTimerComplete(skipSound = false) {
            clearInterval(timerInterval);
            timerState.isRunning = false;
            timerState.endTime = null;
            
            // éœ‡å‹•æé†’
            vibrate([200, 100, 200, 100, 300]);
            
            if (timerState.phase === 'work') {
                // å·¥ä½œå®Œæˆ
                timerState.pomodoroCount++;
                timerState.sessionCount++;
                stats.todayCount++;
                stats.totalPomodoros++;
                const workMin = timerState.mode === 'classroom' ? settings.classTime : settings.workDuration;
                stats.todayMinutes += workMin;
                stats.totalMinutes += workMin;
                
                // ç«‹å³ä¿å­˜çµ±è¨ˆï¼ˆé‡è¦ï¼šèƒŒæ™¯å®Œæˆæ™‚ç¢ºä¿æ•¸æ“šä¸ä¸Ÿå¤±ï¼‰
                saveStats();
                console.log('ğŸ… ç•ªèŒ„å®Œæˆï¼ä»Šæ—¥:', stats.todayCount, 'ç¸½è¨ˆ:', stats.totalPomodoros);
                
                // æª¢æŸ¥æˆå°±
                checkAchievements();
                
                // æ›´æ–°ç•ªèŒ„æ£®æ—
                updateForest();
                
                updatePomodoroCount();

                // æ›´æ–°å¾…è¾¦äº‹é …
                if (activeTodoIndex >= 0 && todos[activeTodoIndex]) {
                    todos[activeTodoIndex].pomodoros++;
                    saveTodos();
                    updateTodoList();
                }

                // ğŸ—£ï¸ èªéŸ³å„ªå…ˆï¼ˆæ›´å¯é ï¼‰ï¼ŒéŸ³æ•ˆå»¶é²æ’­æ”¾
                sendNotification('ğŸ… å·¥ä½œå®Œæˆï¼', `ä»Šæ—¥ ${stats.todayCount}/${settings.dailyGoal} å€‹ç•ªèŒ„`);
                
                // ç¢ºä¿èªéŸ³æ’­æ”¾ï¼ˆå»¶é²ä¸€é»è®“ UI å…ˆæ›´æ–°ï¼‰
                console.log('ğŸ”” å·¥ä½œå®Œæˆï¼Œæº–å‚™æ’­æ”¾èªéŸ³');
                showToast('ğŸ… å·¥ä½œå®Œæˆï¼æº–å‚™æ’­æ”¾èªéŸ³...');
                
                setTimeout(() => {
                    console.log('â° è§¸ç™¼å·¥ä½œå®ŒæˆèªéŸ³å’Œ LINE');
                    console.log('â° èªéŸ³æœå‹™:', settings.voiceService);
                    speakWorkComplete();
                }, 300);
                
                if (!skipSound) {
                    setTimeout(() => playSound(), 800); // èªéŸ³å¾Œæ’­éŸ³æ•ˆ
                }

                // åˆ¤æ–·æ˜¯å¦é•·ä¼‘æ¯
                if (timerState.pomodoroCount >= settings.longBreakInterval) {
                    timerState.phase = 'longRest';
                    timerState.timeLeft = settings.longBreak * 60;
                    timerState.totalTime = settings.longBreak * 60;
                    timerState.pomodoroCount = 0;
                    document.getElementById('restModalTitle').textContent = 'ğŸŒ´ é•·ä¼‘æ¯æ™‚é–“ï¼';
                    document.getElementById('restModalIcon').textContent = 'ğŸŒ´';
                } else {
                    timerState.phase = 'rest';
                    if (timerState.mode === 'classroom') {
                        timerState.timeLeft = settings.breakTime * 60;
                        timerState.totalTime = settings.breakTime * 60;
                        document.getElementById('restModalTitle').textContent = 'ğŸ‰ ä¸‹èª²æ™‚é–“ï¼';
                        document.getElementById('restModalIcon').textContent = 'ğŸ‰';
                    } else {
                        timerState.timeLeft = settings.shortBreak * 60;
                        timerState.totalTime = settings.shortBreak * 60;
                        document.getElementById('restModalTitle').textContent = 'â˜• ä¼‘æ¯æ™‚é–“åˆ°ï¼';
                        document.getElementById('restModalIcon').textContent = 'â˜•';
                    }
                }

                updateTimerStyle();
                showRestModal();
                startRestTimer();

            } else {
                // ä¼‘æ¯å®Œæˆ
                timerState.phase = 'work';
                if (timerState.mode === 'classroom') {
                    timerState.timeLeft = settings.classTime * 60;
                    timerState.totalTime = settings.classTime * 60;
                } else {
                    timerState.timeLeft = settings.workDuration * 60;
                    timerState.totalTime = settings.workDuration * 60;
                }

                // ğŸ—£ï¸ èªéŸ³å„ªå…ˆï¼ŒéŸ³æ•ˆå»¶é²
                sendNotification('â˜• ä¼‘æ¯çµæŸï¼', 'æº–å‚™é–‹å§‹å·¥ä½œ');
                
                // ç¢ºä¿èªéŸ³æ’­æ”¾ï¼ˆå»¶é²ä¸€é»è®“ UI å…ˆæ›´æ–°ï¼‰
                setTimeout(() => {
                    console.log('â° è§¸ç™¼ä¼‘æ¯çµæŸèªéŸ³å’Œ LINE');
                    speakRestComplete();
                }, 100);
                
                setTimeout(() => playShortBeep(), 600);
                
                hideRestModal();
                updateTimerStyle();
                updateTimerDisplay();
                updateStartButton();
                
                // ä¼‘æ¯çµæŸï¼Œé‡‹æ”¾ Wake Lock
                handleWakeLockOnTimerStop();
            }

            updateStatsDisplay();
        }

        function startRestTimer() {
            timerState.isRunning = true;
            timerState.endTime = Date.now() + timerState.timeLeft * 1000;
            startBreathingAnimation();
            
            // ğŸ”” ç™¼é€ä¼‘æ¯è¨ˆæ™‚åˆ° GAS
            sendTimerToGAS('rest', Math.ceil(timerState.timeLeft / 60));

            timerInterval = setInterval(() => {
                // ç”¨æ™‚é–“æˆ³è¨ˆç®—å‰©é¤˜æ™‚é–“
                const now = Date.now();
                const remaining = Math.max(0, Math.ceil((timerState.endTime - now) / 1000));
                timerState.timeLeft = remaining;
                updateTimerDisplay();
                updateRestModalTimer();

                if (timerState.timeLeft <= 0) {
                    handleTimerComplete();
                }
            }, 1000);
        }

        // ============================================
        // é¡¯ç¤ºæ›´æ–°
        // ============================================
        function updateTimerDisplay() {
            const minutes = Math.floor(timerState.timeLeft / 60);
            const seconds = timerState.timeLeft % 60;
            document.getElementById('timerDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            // æ›´æ–°åœ“ç’°é€²åº¦
            const progress = document.getElementById('timerProgress');
            const circumference = 2 * Math.PI * 130;
            const offset = circumference * (1 - timerState.timeLeft / timerState.totalTime);
            progress.style.strokeDashoffset = offset;
        }

        function updateTimerStyle() {
            const progress = document.getElementById('timerProgress');
            const label = document.getElementById('timerLabel');
            const emoji = document.getElementById('timerEmoji');
            const startBtn = document.getElementById('startBtn');

            if (timerState.phase === 'work') {
                progress.classList.remove('rest');
                if (timerState.mode === 'classroom') {
                    label.textContent = 'ä¸Šèª²æ™‚é–“';
                    emoji.textContent = 'ğŸ“š';
                } else {
                    label.textContent = 'å·¥ä½œæ™‚é–“';
                    emoji.textContent = 'ğŸ…';
                }
                startBtn.classList.remove('rest-mode');
            } else {
                progress.classList.add('rest');
                if (timerState.phase === 'longRest') {
                    label.textContent = 'é•·ä¼‘æ¯';
                    emoji.textContent = 'ğŸŒ´';
                } else if (timerState.mode === 'classroom') {
                    label.textContent = 'ä¸‹èª²æ™‚é–“';
                    emoji.textContent = 'ğŸ‰';
                } else {
                    label.textContent = 'ä¼‘æ¯æ™‚é–“';
                    emoji.textContent = 'â˜•';
                }
                startBtn.classList.add('rest-mode');
            }
        }

        function updateStartButton() {
            const btn = document.getElementById('startBtn');
            const icon = document.getElementById('startIcon');
            const text = document.getElementById('startText');

            if (timerState.isRunning) {
                btn.classList.add('running');
                icon.textContent = 'â¸';
                text.textContent = 'æš«åœ';
            } else {
                btn.classList.remove('running');
                icon.textContent = 'â–¶';
                text.textContent = 'é–‹å§‹';
            }
        }

        function updateStatsDisplay() {
            document.getElementById('todayCount').textContent = stats.todayCount;
            document.getElementById('todayMinutes').textContent = stats.todayMinutes;
            document.getElementById('streakDays').textContent = stats.streak;
            document.getElementById('bestStreak').textContent = stats.bestStreak;
            
            // æ›´æ–°æ¯æ—¥ç›®æ¨™é€²åº¦
            updateGoalProgress();
        }

        // ============================================
        // æ¯æ—¥ç›®æ¨™
        // ============================================
        function updateGoalProgress() {
            const progress = Math.min(100, (stats.todayCount / settings.dailyGoal) * 100);
            document.getElementById('goalProgress').textContent = `${stats.todayCount}/${settings.dailyGoal}`;
            document.getElementById('goalProgressBar').style.width = progress + '%';
            
            // é”æ¨™æ™‚è®Šé‡‘è‰²
            if (stats.todayCount >= settings.dailyGoal) {
                document.getElementById('goalProgressBar').style.background = 'linear-gradient(90deg, #ffd700, #ffaa00)';
            } else {
                document.getElementById('goalProgressBar').style.background = 'linear-gradient(90deg, #30d158, #34c759)';
            }
        }

        function saveDailyGoal() {
            settings.dailyGoal = parseInt(document.getElementById('dailyGoal').value) || 8;
            saveSettings();
            updateGoalProgress();
            showToast(`ğŸ¯ æ¯æ—¥ç›®æ¨™è¨­ç‚º ${settings.dailyGoal} å€‹ç•ªèŒ„`);
        }

        // ============================================
        // éœ‡å‹•æé†’
        // ============================================
        function vibrate(pattern = [200, 100, 200, 100, 200]) {
            if (!settings.vibrate) return;
            if ('vibrate' in navigator) {
                try {
                    navigator.vibrate(pattern);
                    console.log('ğŸ“³ éœ‡å‹•å·²è§¸ç™¼');
                } catch (e) {
                    console.log('éœ‡å‹•å¤±æ•—:', e);
                }
            }
        }

        function testVibrate() {
            if ('vibrate' in navigator) {
                navigator.vibrate([100, 50, 100, 50, 100]);
                showToast('ğŸ“³ éœ‡å‹•æ¸¬è©¦');
            } else {
                showToast('âŒ æ­¤è£ç½®ä¸æ”¯æ´éœ‡å‹•');
            }
        }

        // ============================================
        // ç•ªèŒ„æ£®æ—
        // ============================================
        function updateForest() {
            const container = document.getElementById('forestContainer');
            if (!container) return;
            
            // è¨ˆç®—ç¸½æ¨¹æœ¨æ•¸
            let totalTrees = 0;
            let html = '';
            
            // æ ¹æ“šæ­·å²è¨˜éŒ„ç”Ÿæˆæ¨¹æœ¨
            const allDays = [...stats.history];
            if (stats.todayCount > 0) {
                allDays.push({ count: stats.todayCount, date: 'today' });
            }
            
            allDays.forEach(day => {
                const tree = getTreeType(day.count);
                if (tree) {
                    totalTrees++;
                    html += `<div style="font-size:${20 + tree.min}px;transition:transform 0.3s;" title="${tree.name} (${day.count}å€‹ç•ªèŒ„)">${tree.icon}</div>`;
                }
            });
            
            if (html === '') {
                html = '<div style="color:#fff;text-shadow:1px 1px 2px rgba(0,0,0,0.3);font-size:14px;">å®Œæˆç•ªèŒ„ä¾†ç¨®æ¤ä½ çš„æ£®æ— ğŸŒ±</div>';
            }
            
            container.innerHTML = html;
            document.getElementById('forestStats').textContent = 
                `ç´¯è¨ˆ ${stats.totalPomodoros} å€‹ç•ªèŒ„ï¼Œç¨®äº† ${totalTrees} æ£µæ¨¹`;
        }

        function getTreeType(count) {
            let result = null;
            for (const tree of TREE_TYPES) {
                if (count >= tree.min) {
                    result = tree;
                }
            }
            return result;
        }

        // ============================================
        // æˆå°±ç³»çµ±
        // ============================================
        function checkAchievements() {
            let newAchievement = false;
            
            ACHIEVEMENTS.forEach(achievement => {
                if (!stats.achievements.includes(achievement.id)) {
                    if (achievement.condition(stats)) {
                        stats.achievements.push(achievement.id);
                        newAchievement = true;
                        showAchievementPopup(achievement);
                    }
                }
            });
            
            if (newAchievement) {
                saveStats();
                updateAchievementList();
            }
        }

        function showAchievementPopup(achievement) {
            showToast(`ğŸ† æˆå°±è§£é–ï¼š${achievement.icon} ${achievement.name}ï¼`);
            vibrate([100, 50, 100, 50, 200, 100, 200]);
        }

        function updateAchievementList() {
            const container = document.getElementById('achievementList');
            if (!container) return;
            
            let html = '';
            ACHIEVEMENTS.forEach(achievement => {
                const unlocked = stats.achievements.includes(achievement.id);
                html += `
                    <div style="padding:12px;background:var(--bg-tertiary);border-radius:12px;opacity:${unlocked ? 1 : 0.4};${unlocked ? 'border:2px solid var(--accent);' : ''}">
                        <div style="font-size:24px;text-align:center;">${achievement.icon}</div>
                        <div style="font-size:12px;font-weight:600;text-align:center;margin-top:4px;">${achievement.name}</div>
                        <div style="font-size:10px;color:var(--text-secondary);text-align:center;margin-top:2px;">${achievement.desc}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            document.getElementById('achievementCount').textContent = stats.achievements.length;
        }

        // ============================================
        // è³‡æ–™åŒ¯å‡º
        // ============================================
        function exportData(format) {
            let content, filename, type;
            
            if (format === 'csv') {
                content = generateCSV();
                filename = `pomodoro_${new Date().toISOString().split('T')[0]}.csv`;
                type = 'text/csv;charset=utf-8';
            } else {
                content = JSON.stringify({
                    settings: settings,
                    stats: stats,
                    todos: todos,
                    exportDate: new Date().toISOString()
                }, null, 2);
                filename = `pomodoro_${new Date().toISOString().split('T')[0]}.json`;
                type = 'application/json';
            }
            
            // æ·»åŠ  BOM ä»¥æ”¯æ´ä¸­æ–‡
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + content], { type: type });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast(`ğŸ’¾ å·²åŒ¯å‡º ${filename}`);
        }

        function generateCSV() {
            let csv = 'æ—¥æœŸ,ç•ªèŒ„æ•¸,å°ˆæ³¨åˆ†é˜\n';
            
            // æ­·å²è³‡æ–™
            stats.history.forEach(day => {
                csv += `${day.date},${day.count},${day.minutes}\n`;
            });
            
            // ä»Šæ—¥
            if (stats.todayCount > 0) {
                const today = new Date();
                csv += `${today.getMonth()+1}/${today.getDate()},${stats.todayCount},${stats.todayMinutes}\n`;
            }
            
            // çµ±è¨ˆæ‘˜è¦
            csv += '\nçµ±è¨ˆæ‘˜è¦\n';
            csv += `ç¸½ç•ªèŒ„æ•¸,${stats.totalPomodoros}\n`;
            csv += `ç¸½å°ˆæ³¨åˆ†é˜,${stats.totalMinutes}\n`;
            csv += `æœ€ä½³é€£çºŒå¤©æ•¸,${stats.bestStreak}\n`;
            csv += `å·²è§£é–æˆå°±,${stats.achievements.length}\n`;
            
            return csv;
        }

        function updatePomodoroCount() {
            const dots = document.querySelectorAll('.pomodoro-dot');
            dots.forEach((dot, index) => {
                dot.classList.remove('completed', 'long-break');
                if (index < timerState.pomodoroCount) {
                    dot.classList.add('completed');
                }
            });
        }

        function updateStatusTime() {
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ':' + 
                           now.getMinutes().toString().padStart(2, '0');
            document.querySelectorAll('.status-time').forEach(el => el.textContent = timeStr);
        }

        // ============================================
        // æ•´é»æ¨¡å¼
        // ============================================
        function startHourlyCheck() {
            // æ¯ç§’æª¢æŸ¥ä¸€æ¬¡ï¼Œè®“é€²åº¦ç’°èƒ½å¹³æ»‘æ›´æ–°
            hourlyCheckInterval = setInterval(checkHourlyReminder, 1000);
            checkHourlyReminder();
        }

        function checkHourlyReminder() {
            if (timerState.mode !== 'hourly') return;
            if (isInSleepTime()) return;
            if (timerState.phase === 'rest') return;

            const now = new Date();
            const currentMinute = now.getMinutes();
            const currentHour = now.getHours();
            const key = `${currentHour}:${currentMinute}`;

            if (currentMinute === settings.hourlyMinute && lastHourlyReminder !== key) {
                lastHourlyReminder = key;
                triggerHourlyReminder();
                return;
            }

            updateHourlyDisplay();
        }

        function triggerHourlyReminder() {
            // ğŸ—£ï¸ èªéŸ³å„ªå…ˆ
            speakHourlyReminder();
            setTimeout(() => playSound(), 500);  // èªéŸ³å¾Œæ’­éŸ³æ•ˆ
            
            // éœ‡å‹•æé†’
            vibrate([200, 100, 200, 100, 300]);
            
            sendNotification('â° æ•´é»æé†’ï¼', `ä»Šæ—¥ ${stats.todayCount + 1}/${settings.dailyGoal} å€‹ç•ªèŒ„`);

            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            // è¨˜éŒ„ç•ªèŒ„æ•¸ï¼ˆæ•´é»æ¨¡å¼ä¹Ÿè¦è¨ˆå…¥ï¼‰
            timerState.pomodoroCount++;
            timerState.sessionCount++;
            stats.todayCount++;
            stats.totalPomodoros++;
            stats.todayMinutes += settings.hourlyMinute;
            stats.totalMinutes += settings.hourlyMinute;
            updatePomodoroCount();
            saveStats();
            updateStatsDisplay();
            
            // æª¢æŸ¥æˆå°±
            checkAchievements();
            updateForest();

            // æ›´æ–°å¾…è¾¦äº‹é …
            if (activeTodoIndex >= 0 && todos[activeTodoIndex]) {
                todos[activeTodoIndex].pomodoros++;
                saveTodos();
                updateTodoList();
            }

            timerState.phase = 'rest';
            timerState.isRunning = true;
            timerState.timeLeft = settings.shortBreak * 60;
            timerState.totalTime = settings.shortBreak * 60;
            timerState.endTime = Date.now() + timerState.timeLeft * 1000;

            document.getElementById('timerLabel').textContent = 'ä¼‘æ¯æ™‚é–“';
            updateTimerDisplay();
            updateTimerStyle();
            showRestModal();

            timerInterval = setInterval(function() {
                // ç”¨æ™‚é–“æˆ³è¨ˆç®—å‰©é¤˜æ™‚é–“
                const now = Date.now();
                const remaining = Math.max(0, Math.ceil((timerState.endTime - now) / 1000));
                timerState.timeLeft = remaining;
                updateTimerDisplay();
                updateRestModalTimer();
                
                if (timerState.timeLeft <= 0) {
                    endRest();
                }
            }, 1000);
        }

        function updateHourlyDisplay() {
            if (timerState.mode !== 'hourly') return;
            if (timerState.phase === 'rest' && timerState.isRunning) return;

            const now = new Date();
            const currentMinute = now.getMinutes();
            const currentSecond = now.getSeconds();
            
            let minutesUntil = settings.hourlyMinute - currentMinute;
            if (minutesUntil <= 0) minutesUntil += 60;
            
            // è¨ˆç®—ç²¾ç¢ºçš„å‰©é¤˜ç§’æ•¸
            const secondsUntil = minutesUntil * 60 - currentSecond;

            // totalTime å›ºå®šç‚º 60 åˆ†é˜ï¼ˆä¸€å€‹å®Œæ•´é€±æœŸï¼‰
            timerState.totalTime = 60 * 60; // 60 åˆ†é˜
            timerState.timeLeft = secondsUntil;

            // æ›´æ–°é¡¯ç¤º
            const displayMinutes = Math.floor(secondsUntil / 60);
            const displaySeconds = secondsUntil % 60;
            document.getElementById('timerDisplay').textContent = 
                `${displayMinutes.toString().padStart(2, '0')}:${displaySeconds.toString().padStart(2, '0')}`;
            document.getElementById('timerLabel').textContent = 'è·é›¢ä¸‹æ¬¡ä¼‘æ¯';
            
            // æ›´æ–°é€²åº¦ç’°ï¼ˆç¶ è‰² = å‰©é¤˜æ™‚é–“ï¼‰
            // å‰©é¤˜è¶Šå¤šï¼Œç¶ è‰²è¶Šå¤šï¼›å€’æ•¸åˆ° 0 æ™‚ç¶ è‰²æ¶ˆå¤±
            const progress = document.getElementById('timerProgress');
            const circumference = 2 * Math.PI * 130;
            const offset = circumference * (1 - timerState.timeLeft / timerState.totalTime);
            progress.style.strokeDashoffset = offset;
        }

        function isInSleepTime() {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            const [startH, startM] = settings.sleepStart.split(':').map(Number);
            const [endH, endM] = settings.sleepEnd.split(':').map(Number);
            const sleepStart = startH * 60 + startM;
            const sleepEnd = endH * 60 + endM;

            if (sleepStart <= sleepEnd) {
                return currentTime >= sleepStart && currentTime < sleepEnd;
            } else {
                return currentTime >= sleepStart || currentTime < sleepEnd;
            }
        }

        // ============================================
        // ä¼‘æ¯å½ˆçª—
        // ============================================
        function showRestModal() {
            const activity = restActivities[Math.floor(Math.random() * restActivities.length)];
            document.getElementById('restActivity').innerHTML = `
                <div class="rest-modal-activity-icon">${activity.icon}</div>
                <div class="rest-modal-activity-text">${activity.text}</div>
            `;

            const minutes = Math.floor(timerState.timeLeft / 60);
            const seconds = timerState.timeLeft % 60;
            document.getElementById('restModalTimer').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;

            document.getElementById('restModal').classList.add('show');
            startBreathingAnimation();
        }

        function hideRestModal() {
            document.getElementById('restModal').classList.remove('show');
            stopBreathingAnimation();
        }

        function updateRestModalTimer() {
            const minutes = Math.floor(timerState.timeLeft / 60);
            const seconds = timerState.timeLeft % 60;
            document.getElementById('restModalTimer').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function endRest() {
            clearInterval(timerInterval);
            timerState.isRunning = false;
            timerState.phase = 'work';
            timerState.endTime = null;
            hideRestModal();
            
            // ğŸ—£ï¸ èªéŸ³å„ªå…ˆ
            speakRestComplete();
            setTimeout(() => playShortBeep(), 500);
            
            // éœ‡å‹•
            vibrate([100, 50, 100]);

            sendNotification('â˜• ä¼‘æ¯çµæŸï¼', 'æº–å‚™é–‹å§‹å·¥ä½œ');

            if (timerState.mode === 'countdown') {
                timerState.timeLeft = settings.workDuration * 60;
                timerState.totalTime = settings.workDuration * 60;
                updateTimerDisplay();
                updateTimerStyle();
                updateStartButton();
            } else if (timerState.mode === 'classroom') {
                timerState.timeLeft = settings.classTime * 60;
                timerState.totalTime = settings.classTime * 60;
                updateTimerDisplay();
                updateTimerStyle();
                updateStartButton();
            } else {
                updateHourlyDisplay();
            }
        }

        // å‘¼å¸å‹•ç•«
        function startBreathingAnimation() {
            const texts = ['å¸æ°£...', 'æ†‹ä½...', 'åæ°£...', 'æ”¾é¬†...'];
            let index = 0;
            
            breathingInterval = setInterval(() => {
                document.getElementById('breathingText').textContent = texts[index];
                index = (index + 1) % texts.length;
            }, 4000);
        }

        function stopBreathingAnimation() {
            if (breathingInterval) {
                clearInterval(breathingInterval);
                breathingInterval = null;
            }
        }

        // ============================================
        // å¾…è¾¦äº‹é …
        // ============================================
        function toggleTodoInput() {
            document.getElementById('todoInputContainer').classList.toggle('show');
            document.getElementById('todoInput').focus();
        }

        function addTodo() {
            const input = document.getElementById('todoInput');
            const text = input.value.trim();
            if (!text) return;

            todos.push({
                id: Date.now(),
                text: text,
                completed: false,
                pomodoros: 0
            });

            input.value = '';
            document.getElementById('todoInputContainer').classList.remove('show');
            saveTodos();
            updateTodoList();
            showToast('âœ… ä»»å‹™å·²æ–°å¢');
        }

        function toggleTodo(index) {
            todos[index].completed = !todos[index].completed;
            saveTodos();
            updateTodoList();
        }

        function setActiveTodo(index) {
            activeTodoIndex = index;
            updateTodoList();
            showToast(`ğŸ¯ å°ˆæ³¨æ–¼ï¼š${todos[index].text}`);
        }

        function deleteTodo(index) {
            todos.splice(index, 1);
            if (activeTodoIndex === index) activeTodoIndex = -1;
            saveTodos();
            updateTodoList();
        }

        function updateTodoList() {
            const list = document.getElementById('todoList');
            
            if (todos.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:var(--text-tertiary);padding:20px;">å°šç„¡å¾…è¾¦äº‹é …</div>';
                return;
            }

            list.innerHTML = todos.map((todo, index) => `
                <div class="todo-item ${todo.completed ? 'completed' : ''} ${index === activeTodoIndex ? 'active' : ''}" 
                     onclick="setActiveTodo(${index})">
                    <div class="todo-checkbox" onclick="event.stopPropagation();toggleTodo(${index})">
                        ${todo.completed ? 'âœ“' : ''}
                    </div>
                    <div class="todo-text">${todo.text}</div>
                    <div class="todo-pomodoros">ğŸ… ${todo.pomodoros}</div>
                    <div class="todo-delete" onclick="event.stopPropagation();deleteTodo(${index})">âœ•</div>
                </div>
            `).join('');
        }

        // ============================================
        // åœ–è¡¨
        // ============================================
        function updateChart() {
            const container = document.getElementById('chartBars');
            const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            const today = new Date().getDay();
            
            const maxValue = Math.max(...stats.weeklyData, 1);

            let html = '';
            for (let i = 0; i < 7; i++) {
                const dayIndex = (today - 6 + i + 7) % 7;
                const value = stats.weeklyData[i] || 0;
                const height = (value / maxValue) * 100;
                const isToday = i === 6;

                html += `
                    <div class="chart-bar-group">
                        <div class="chart-bar" style="height:${height}px;${isToday ? 'opacity:1;' : 'opacity:0.6;'}"></div>
                        <div class="chart-bar-label" style="${isToday ? 'color:var(--accent-blue);font-weight:600;' : ''}">${days[dayIndex]}</div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function setChartView(view) {
            document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
            // æ‰¾åˆ°å°æ‡‰çš„ tab ä¸¦åŠ ä¸Š active
            document.querySelectorAll('.chart-tab').forEach(t => {
                if (t.getAttribute('onclick').includes(`'${view}'`)) {
                    t.classList.add('active');
                }
            });
            // å¯ä»¥æ“´å±•ç‚ºæœˆè¦–åœ–
            updateChart();
        }

        function updateHistoryList() {
            const list = document.getElementById('historyList');
            const history = stats.history.slice(-10).reverse();

            if (history.length === 0) {
                list.innerHTML = '<div class="setting-item" style="justify-content:center;color:var(--text-tertiary);">å°šç„¡æ­·å²ç´€éŒ„</div>';
                return;
            }

            list.innerHTML = history.map(item => `
                <div class="history-item">
                    <div class="history-date">${item.date}</div>
                    <div class="history-stats">
                        <div class="history-stat">
                            <div class="history-stat-value">${item.count}</div>
                            <div class="history-stat-label">ç•ªèŒ„</div>
                        </div>
                        <div class="history-stat">
                            <div class="history-stat-value">${item.minutes}</div>
                            <div class="history-stat-label">åˆ†é˜</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ============================================
        // ç™½å™ªéŸ³
        // ============================================
        function toggleAmbient(type) {
            // å…ˆåˆå§‹åŒ–éŸ³æ•ˆ
            if (!audioContext) initAudio();
            
            document.querySelectorAll('.ambient-btn').forEach(btn => btn.classList.remove('active'));
            
            if (type === 'none' || type === currentAmbient) {
                stopAmbient();
                currentAmbient = 'none';
                showToast('ğŸ”‡ ç™½å™ªéŸ³å·²é—œé–‰');
                return;
            }

            // æ‰¾åˆ°å°æ‡‰çš„æŒ‰éˆ•ä¸¦åŠ ä¸Š active
            document.querySelectorAll('.ambient-btn').forEach(btn => {
                if (btn.getAttribute('onclick').includes(`'${type}'`)) {
                    btn.classList.add('active');
                }
            });
            
            currentAmbient = type;
            playAmbient(type);
        }

        function playAmbient(type) {
            stopAmbient();

            // ä½¿ç”¨ Web Audio API ç”Ÿæˆç™½å™ªéŸ³
            if (!audioContext) initAudio();
            if (!audioContext) return;
            
            // ç¢ºä¿ context æ˜¯é‹è¡Œç‹€æ…‹
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            try {
                const bufferSize = 2 * audioContext.sampleRate;
                const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
                const output = noiseBuffer.getChannelData(0);

                // æ ¹æ“šé¡å‹ç”Ÿæˆä¸åŒçš„å™ªéŸ³
                for (let i = 0; i < bufferSize; i++) {
                    if (type === 'rain' || type === 'ocean') {
                        output[i] = Math.random() * 2 - 1;
                    } else if (type === 'forest' || type === 'wind') {
                        output[i] = (Math.random() * 2 - 1) * 0.5;
                    } else {
                        output[i] = (Math.random() * 2 - 1) * 0.3;
                    }
                }

                ambientAudio = audioContext.createBufferSource();
                ambientAudio.buffer = noiseBuffer;
                ambientAudio.loop = true;

                ambientGainNode = audioContext.createGain();
                ambientGainNode.gain.value = document.getElementById('ambientVolume').value / 100 * 0.3;

                // åŠ å…¥æ¿¾æ³¢å™¨è®“è²éŸ³æ›´è‡ªç„¶
                const filter = audioContext.createBiquadFilter();
                if (type === 'rain') {
                    filter.type = 'lowpass';
                    filter.frequency.value = 1000;
                } else if (type === 'ocean') {
                    filter.type = 'lowpass';
                    filter.frequency.value = 500;
                } else if (type === 'forest') {
                    filter.type = 'bandpass';
                    filter.frequency.value = 2000;
                } else {
                    filter.type = 'lowpass';
                    filter.frequency.value = 800;
                }

                ambientAudio.connect(filter);
                filter.connect(ambientGainNode);
                ambientGainNode.connect(audioContext.destination);
                ambientAudio.start();

                showToast(`ğŸµ ${type === 'rain' ? 'é›¨è²' : type === 'cafe' ? 'å’–å•¡å»³' : type === 'forest' ? 'æ£®æ—' : type === 'ocean' ? 'æµ·æµª' : type === 'fire' ? 'å£çˆ' : type === 'wind' ? 'å¾®é¢¨' : 'å¤œæ™š'}å·²é–‹å•Ÿ`);
            } catch (e) {
                console.log('ç™½å™ªéŸ³æ’­æ”¾å¤±æ•—:', e);
            }
        }

        function stopAmbient() {
            if (ambientAudio) {
                try {
                    ambientAudio.stop();
                } catch (e) {}
                ambientAudio = null;
            }
        }

        function setAmbientVolume(value) {
            // ç›´æ¥èª¿æ•´éŸ³é‡ï¼ˆå¦‚æœæœ‰ gainNodeï¼‰
            if (ambientGainNode) {
                ambientGainNode.gain.value = value / 100 * 0.3;
            }
        }

        // ============================================
        // éŸ³æ•ˆç³»çµ±ï¼ˆä¿®å¾©èƒŒæ™¯å–šé†’å•é¡Œï¼‰
        // ============================================
        let notificationAudio = null; // HTML Audio å…ƒç´ ç”¨æ–¼æ’­æ”¾å¤–éƒ¨éŸ³æ•ˆ
        
        function initAudio() {
            if (audioContext) {
                // é‡æ–°æ¿€æ´»å·²å­˜åœ¨çš„ context
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                return;
            }
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                console.log('ğŸ”Š AudioContext å·²åˆå§‹åŒ–');
            } catch (e) {
                console.log('éŸ³æ•ˆåˆå§‹åŒ–å¤±æ•—:', e);
            }
        }

        // é é¢å¯è¦‹æ€§è®ŠåŒ–æ™‚é‡æ–°æ¿€æ´»éŸ³æ•ˆå’Œè¨ˆæ™‚å™¨
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                console.log('ğŸ“± é é¢å–šé†’');
                
                // é‡æ–°æ¿€æ´»éŸ³æ•ˆ
                if (audioContext && audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        console.log('âœ… AudioContext å·²æ¢å¾©');
                        // å¦‚æœç™½å™ªéŸ³æ­£åœ¨æ’­æ”¾ï¼Œé‡æ–°å•Ÿå‹•
                        if (currentAmbient !== 'none') {
                            console.log('ğŸµ é‡æ–°å•Ÿå‹•ç™½å™ªéŸ³:', currentAmbient);
                            playAmbient(currentAmbient);
                        }
                    });
                }
                
                // é‡æ–°è¨ˆç®—è¨ˆæ™‚å™¨ï¼ˆèƒŒæ™¯æ™‚å¯èƒ½è¢«ç¯€æµï¼‰
                if (timerState.isRunning && timerState.endTime) {
                    const now = Date.now();
                    const remaining = Math.ceil((timerState.endTime - now) / 1000);
                    
                    console.log('ğŸ“Š èƒŒæ™¯æª¢æŸ¥:', {
                        phase: timerState.phase,
                        remaining: remaining,
                        todayCount: stats.todayCount
                    });
                    
                    if (remaining <= 0) {
                        // æ™‚é–“å·²åˆ°ï¼Œè§¸ç™¼å®Œæˆ
                        console.log('â° èƒŒæ™¯è¨ˆæ™‚å®Œæˆï¼Œphase:', timerState.phase);
                        timerState.timeLeft = 0;
                        
                        // è¨˜éŒ„å®Œæˆå‰çš„ç‹€æ…‹
                        const wasWorkPhase = timerState.phase === 'work';
                        
                        // å…ˆæ¢å¾© AudioContext
                        const doComplete = () => {
                            playSound();
                            handleTimerComplete(true); // skipSound = true
                            
                            // ç¢ºä¿ UI æ›´æ–°
                            updateStatsDisplay();
                            updateTimerDisplay();
                            
                            if (wasWorkPhase) {
                                console.log('ğŸ… èƒŒæ™¯å®Œæˆå·¥ä½œï¼Œç•ªèŒ„æ•¸:', stats.todayCount);
                                showToast(`ğŸ… èƒŒæ™¯å®Œæˆï¼ä»Šæ—¥ ${stats.todayCount} å€‹ç•ªèŒ„`);
                            }
                        };
                        
                        if (audioContext && audioContext.state === 'suspended') {
                            audioContext.resume().then(doComplete);
                        } else {
                            doComplete();
                        }
                    } else {
                        // æ›´æ–°å‰©é¤˜æ™‚é–“
                        console.log('â±ï¸ æ›´æ–°å‰©é¤˜æ™‚é–“:', remaining, 'ç§’');
                        timerState.timeLeft = remaining;
                        updateTimerDisplay();
                        if (timerState.phase !== 'work') {
                            updateRestModalTimer();
                        }
                    }
                }
                
                // æ•´é»æ¨¡å¼ï¼šæª¢æŸ¥æ˜¯å¦éŒ¯éäº†æé†’
                if (timerState.mode === 'hourly' && timerState.phase === 'work') {
                    checkHourlyReminder();
                }
                
                // ç„¡è«–å¦‚ä½•éƒ½åˆ·æ–°çµ±è¨ˆé¡¯ç¤º
                updateStatsDisplay();
            }
        });

        // ç”¨æˆ¶äº’å‹•æ™‚åˆå§‹åŒ–
        document.addEventListener('click', () => initAudio(), { once: true });
        document.addEventListener('touchstart', () => initAudio(), { once: true });

        // å°æ£®å¹³éŸ³æ•ˆ URL å°æ‡‰è¡¨
        const KOMORI_SOUNDS = {
            // æ´»å‹•/æ…¶ç¥
            'clap': 'https://taira-komori.net/sound_os2/event01/clapping_short.mp3',
            'cheers': 'https://taira-komori.net/sound_os2/event01/cheers1.mp3',
            'cracker': 'https://taira-komori.net/sound_os2/event01/cracker1.mp3',
            'buzzer': 'https://taira-komori.net/sound_os2/event01/buzzer1.mp3',
            'firework': 'https://taira-komori.net/sound_os2/event01/firework1.mp3',
            // éŠæˆ²éŸ³æ•ˆ
            'powerup1': 'https://taira-komori.net/sound_os2/game01/powerup01.mp3',
            'powerup2': 'https://taira-komori.net/sound_os2/game01/powerup02.mp3',
            'powerup3': 'https://taira-komori.net/sound_os2/game01/powerup03.mp3',
            'powerdown1': 'https://taira-komori.net/sound_os2/game01/powerdown01.mp3',
            'coin1': 'https://taira-komori.net/sound_os2/game01/coin01.mp3',
            'coin2': 'https://taira-komori.net/sound_os2/game01/coin02.mp3',
            'coin3': 'https://taira-komori.net/sound_os2/game01/coin03.mp3',
            'button1': 'https://taira-komori.net/sound_os2/game01/button01a.mp3',
            'button2': 'https://taira-komori.net/sound_os2/game01/button02a.mp3',
            'select1': 'https://taira-komori.net/sound_os2/game01/select01.mp3',
            'select2': 'https://taira-komori.net/sound_os2/game01/select02.mp3',
            'jump1': 'https://taira-komori.net/sound_os2/game01/jump01.mp3',
            'jump2': 'https://taira-komori.net/sound_os2/game01/jump02.mp3',
            'cat1': 'https://taira-komori.net/sound_os2/game01/cat_like1a.mp3',
            'cat2': 'https://taira-komori.net/sound_os2/game01/cat_like2a.mp3',
            'blip1': 'https://taira-komori.net/sound_os2/game01/blip01.mp3',
            'blip2': 'https://taira-komori.net/sound_os2/game01/blip02.mp3',
            // æ¨‚å™¨
            'piano': 'https://taira-komori.net/sound_os2/playing01/Mozart1.mp3',
            'guitar': 'https://taira-komori.net/sound_os2/playing01/guitar1.mp3',
            'drum': 'https://taira-komori.net/sound_os2/playing01/drum1.mp3',
            'wadaiko': 'https://taira-komori.net/sound_os2/playing01/Japanese_drum1.mp3',
            // æ’¿å–
            'pickup1': 'https://taira-komori.net/sound_os2/game01/pickup01.mp3',
            'pickup2': 'https://taira-komori.net/sound_os2/game01/pickup02.mp3'
        };

        const NOTES = {
            'E4': 329.63, 'C4': 261.63, 'D4': 293.66,
            'G3': 196.00, 'G4': 392.00, 'A4': 440.00,
            'B4': 493.88, 'C5': 523.25, 'F4': 349.23
        };

        function playNote(frequency, startTime, duration, volume = 0.3, type = 'triangle') {
            if (!audioContext) return;
            
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            
            osc.connect(gain);
            gain.connect(audioContext.destination);
            
            osc.type = type;
            osc.frequency.value = frequency;
            
            gain.gain.setValueAtTime(volume, startTime);
            gain.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
            
            osc.start(startTime);
            osc.stop(startTime + duration);
        }

        // æ’­æ”¾å°æ£®å¹³å¤–éƒ¨éŸ³æ•ˆï¼ˆä½¿ç”¨ HTML Audioï¼Œæ›´å¯é ï¼‰
        function playKomoriSound(soundKey) {
            const url = KOMORI_SOUNDS[soundKey];
            if (!url) return;

            try {
                // åœæ­¢ä¹‹å‰çš„éŸ³æ•ˆ
                if (notificationAudio) {
                    notificationAudio.pause();
                    notificationAudio = null;
                }
                
                notificationAudio = new Audio(url);
                notificationAudio.volume = 0.7;
                
                // ä½¿ç”¨ play() çš„ promise è™•ç†
                const playPromise = notificationAudio.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log('éŸ³æ•ˆæ’­æ”¾å¤±æ•—ï¼Œå˜—è©¦é‡æ–°æ’­æ”¾:', error);
                        // å˜—è©¦ç”¨æˆ¶äº’å‹•å¾Œé‡æ’­
                    });
                }
                
                console.log('ğŸ”Š æ’­æ”¾å°æ£®å¹³éŸ³æ•ˆ:', soundKey);
            } catch (e) {
                console.log('å°æ£®å¹³éŸ³æ•ˆéŒ¯èª¤:', e);
            }
        }

        // æ’­æ”¾ Web Audio åˆæˆéŸ³æ•ˆ
        function playWebAudioSound(chime) {
            if (!audioContext) initAudio();
            if (!audioContext) return;

            try {
                // ç¢ºä¿ context æ˜¯é‹è¡Œç‹€æ…‹
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }

                const now = audioContext.currentTime;

                if (chime === 'westminster') {
                    playNote(NOTES['E4'], now, 0.6, 0.4);
                    playNote(NOTES['C4'], now + 0.55, 0.6, 0.4);
                    playNote(NOTES['D4'], now + 1.1, 0.6, 0.4);
                    playNote(NOTES['G3'], now + 1.65, 0.8, 0.5);
                    playNote(NOTES['G3'], now + 2.7, 0.6, 0.4);
                    playNote(NOTES['D4'], now + 3.25, 0.6, 0.4);
                    playNote(NOTES['E4'], now + 3.8, 0.6, 0.4);
                    playNote(NOTES['C4'], now + 4.35, 0.8, 0.5);
                } else if (chime === 'school') {
                    for (let i = 0; i < 4; i++) {
                        playNote(NOTES['G4'], now + i * 0.5, 0.4, 0.5);
                    }
                } else if (chime === 'digital') {
                    playNote(880, now, 0.15, 0.3, 'square');
                    playNote(880, now + 0.2, 0.15, 0.3, 'square');
                    playNote(1100, now + 0.4, 0.3, 0.3, 'square');
                } else if (chime === 'gentle') {
                    playNote(NOTES['C5'], now, 0.8, 0.2, 'sine');
                    playNote(NOTES['G4'], now + 0.4, 0.8, 0.2, 'sine');
                    playNote(NOTES['E4'], now + 0.8, 1.0, 0.2, 'sine');
                } else if (chime === 'bird') {
                    playNote(1200, now, 0.1, 0.3, 'sine');
                    playNote(1400, now + 0.15, 0.1, 0.3, 'sine');
                    playNote(1100, now + 0.3, 0.15, 0.3, 'sine');
                    playNote(1300, now + 0.5, 0.1, 0.3, 'sine');
                    playNote(1500, now + 0.65, 0.2, 0.3, 'sine');
                }
            } catch (e) {
                console.log('Web Audio æ’­æ”¾å¤±æ•—:', e);
            }
        }

        function playSound() {
            if (!settings.sound) return;

            // å…ˆå˜—è©¦æ¢å¾© AudioContext
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            if (!audioContext) {
                initAudio();
            }

            const chime = settings.chime;
            const webAudioChimes = ['westminster', 'school', 'digital', 'gentle', 'bird'];

            if (webAudioChimes.includes(chime)) {
                playWebAudioSound(chime);
            } else {
                playKomoriSound(chime);
            }
            
            // å‚™ç”¨ï¼šä½¿ç”¨ç³»çµ±é€šçŸ¥éŸ³ï¼ˆç¢ºä¿èƒŒæ™¯å–šé†’æ™‚èƒ½éŸ¿ï¼‰
            playBackupSound();
        }
        
        // å‚™ç”¨éŸ³æ•ˆï¼ˆä½¿ç”¨ HTML Audioï¼Œæ›´å¯é ï¼‰
        function playBackupSound() {
            try {
                // ä½¿ç”¨ä¸€å€‹ç°¡çŸ­çš„ data URI beep éŸ³æ•ˆ
                const beepDataUri = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdH2Onp2PfnRwcnh4fnqAhIWHhYWEhIaGhoaGh4eHiIiIiIiIiIiIiIiIiIiHh4eGhoaFhYWEhIODgoKBgYCAgIB/f39/fn5+fX19fX18fHx8fHx8fHx8fHx8fHx8fHx8fHx8fH19fX19fX5+fn5/f39/gICAgYGBgoKCg4ODhISEhYWFhoaGh4eHiIiIiIiIiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYiIiIiIiIiHh4eHh4aGhoaGhYWFhYSEhISDg4OCgoKCgYGBgYCAgIB/f39/fn5+fn19fX19fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fH19fX19fX5+fn5+f39/f4CAgICBgYGBgoKCg4ODg4SEhIWFhYWGhoaHh4eHiIiIiIiIiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiIiIiIiIiIeHh4eHhoaGhoWFhYWEhISEg4ODg4KCgoKBgYGBgICAgH9/f39+fn5+fX19fX18fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fX19fX19fn5+fn5/f39/gICAgIGBgYGCgoKDg4ODhISEhYWFhYaGhoeHh4eIiIiIiIiJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmIiIiIiIiIh4eHh4eGhoaGhYWFhYSEhISDg4ODgoKCgoGBgYGAgICAf39/f35+fn59fX19fXx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx9fX19fX1+fn5+fn9/f3+AgICAgYGBgYKCgoODg4OEhISFhYWFhoaGh4eHh4iIiIiIiImJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYiIiIiIiIiHh4eHh4aGhoaFhYWFhISEhIODg4OCgoKCgYGBgYCAgIB/f39/fn5+fn19fX19fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fH19fX19fX5+fn5+f39/f4CAgICBgYGBgoKCg4ODg4SEhIWFhYWGhoaHh4eHiIiIiIiIiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiIiIiIiIiIeHh4eHhoaGhoWFhYWEhISEg4ODg4KCgoKBgYGBgICAgH9/f39+fn5+fX19fX18fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fX19fX19fn5+fn5/f39/gICAgIGBgYGCgoKDg4ODhISEhYWFhYaGhoeHh4eIiIiIiIiJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmIiIiIiIiIh4eHh4eGhoaGhYWFhYSEhISDg4ODgoKCgoGBgYGAgICAf39/f35+fn59fX19fXx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx9fX19fX1+fn5+fn9/f3+AgICAgYGBgYKCgoODg4OEhISFhYWFhoaGh4eHh4iIiIiIiA==';
                
                const audio = new Audio(beepDataUri);
                audio.volume = 0.3;
                audio.play().catch(e => console.log('å‚™ç”¨éŸ³æ•ˆæ’­æ”¾å¤±æ•—:', e));
            } catch (e) {
                console.log('å‚™ç”¨éŸ³æ•ˆéŒ¯èª¤:', e);
            }
        }

        function playShortBeep() {
            if (!settings.sound) return;
            
            // å…ˆå˜—è©¦æ¢å¾© AudioContext
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            if (!audioContext) {
                initAudio();
            }
            
            if (!audioContext) return;
            
            try {
                const now = audioContext.currentTime;
                playNote(NOTES['G4'], now, 0.2, 0.3);
                playNote(NOTES['C5'], now + 0.25, 0.3, 0.3);
            } catch (e) {
                console.log('çŸ­éŸ³æ•ˆæ’­æ”¾å¤±æ•—:', e);
            }
        }

        function testSound() {
            initAudio();
            
            // å¦‚æœæ˜¯å°æ£®å¹³éŸ³æ•ˆï¼Œçµ¦ä¸€é»å»¶é²è®“ç¶²è·¯è¼‰å…¥
            const webAudioChimes = ['westminster', 'school', 'digital', 'gentle', 'bird'];
            const isWebAudio = webAudioChimes.includes(settings.chime);
            
            setTimeout(() => {
                playSound();
            }, isWebAudio ? 100 : 50);
            
            // é¡¯ç¤ºéŸ³æ•ˆåç¨±
            const chimeNames = {
                'westminster': 'ğŸ”” è¥¿æ•å¯º',
                'school': 'ğŸ« å‚³çµ±é˜è²',
                'digital': 'ğŸ“± æ•¸ä½éŸ³',
                'gentle': 'ğŸ è¼•æŸ”éˆ´è²',
                'bird': 'ğŸ¦ é³¥é³´',
                'clap': 'ğŸ‘ æŒè²',
                'cheers': 'ğŸ‰ æ­¡å‘¼',
                'cracker': 'ğŸŠ éŸ¿ç ²',
                'buzzer': 'ğŸ“¢ èœ‚é³´å™¨',
                'firework': 'ğŸ† ç…™ç«',
                'powerup1': 'â¬†ï¸ å‡ç´š1',
                'powerup2': 'â¬†ï¸ å‡ç´š2',
                'powerup3': 'â¬†ï¸ å‡ç´š3',
                'powerdown1': 'â¬‡ï¸ é™ç´š',
                'coin1': 'ğŸª™ é‡‘å¹£1',
                'coin2': 'ğŸª™ é‡‘å¹£2',
                'coin3': 'ğŸª™ é‡‘å¹£3',
                'button1': 'ğŸ”˜ æŒ‰éˆ•1',
                'button2': 'ğŸ”˜ æŒ‰éˆ•2',
                'select1': 'ğŸ‘† é¸æ“‡1',
                'select2': 'ğŸ‘† é¸æ“‡2',
                'jump1': 'ğŸ¦˜ è·³èº1',
                'jump2': 'ğŸ¦˜ è·³èº2',
                'cat1': 'ğŸ± è²“å’ª1',
                'cat2': 'ğŸ± è²“å’ª2',
                'blip1': 'ğŸ“Ÿ å—¶å—¶1',
                'blip2': 'ğŸ“Ÿ å—¶å—¶2',
                'piano': 'ğŸ¹ å°æ˜Ÿæ˜Ÿ',
                'wadaiko': 'ğŸ¥ å¤ªé¼“',
                'pickup1': 'âœ¨ æ’¿å–'
            };
            
            showToast('ğŸ”Š ' + (chimeNames[settings.chime] || settings.chime));
        }

        function setChime(type) {
            settings.chime = type;
            document.querySelectorAll('.chime-option').forEach(btn => btn.classList.remove('active'));
            // æ‰¾åˆ°å°æ‡‰çš„æŒ‰éˆ•ä¸¦åŠ ä¸Š active
            document.querySelectorAll('.chime-option').forEach(btn => {
                if (btn.getAttribute('onclick').includes(`'${type}'`)) {
                    btn.classList.add('active');
                }
            });
            saveSettings();
            testSound();
        }

        // ============================================
        // èªéŸ³æé†’
        // ============================================
        function speak(text) {
            if (!settings.voice) return;
            if ('speechSynthesis' in window) {
                // å…ˆå–æ¶ˆä¹‹å‰çš„èªéŸ³ä¸¦å–šé†’
                speechSynthesis.cancel();
                
                // iOS Safari éœ€è¦å…ˆå–šé†’
                if (speechSynthesis.paused) {
                    speechSynthesis.resume();
                }
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-TW';
                utterance.rate = 0.9;
                utterance.volume = 1.0;
                
                // ç¢ºä¿èªéŸ³å¼•æ“å·²æº–å‚™å¥½
                utterance.onstart = () => console.log('ğŸ—£ï¸ èªéŸ³é–‹å§‹:', text.substring(0, 20) + '...');
                utterance.onerror = (e) => console.log('ğŸ—£ï¸ èªéŸ³éŒ¯èª¤:', e.error);
                
                // å˜—è©¦æ’­æ”¾
                try {
                    speechSynthesis.speak(utterance);
                    console.log('ğŸ—£ï¸ èªéŸ³å·²æ’å…¥:', text.substring(0, 20) + '...');
                } catch (e) {
                    console.log('èªéŸ³æ’­æ”¾å¤±æ•—ï¼Œé‡è©¦ä¸­...', e);
                    setTimeout(() => {
                        speechSynthesis.cancel();
                        speechSynthesis.speak(utterance);
                    }, 100);
                }
            }
        }

        // å¼·åˆ¶å–šé†’èªéŸ³å¼•æ“ï¼ˆç”¨æ–¼èƒŒæ™¯å–šé†’æ™‚ï¼‰
        function wakeSpeechSynthesis() {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                if (speechSynthesis.paused) {
                    speechSynthesis.resume();
                }
                // æ’­æ”¾ä¸€å€‹ç©ºçš„èªéŸ³ä¾†å–šé†’å¼•æ“
                const wake = new SpeechSynthesisUtterance('');
                wake.volume = 0;
                speechSynthesis.speak(wake);
            }
        }

        // è±å¯Œçš„å®ŒæˆèªéŸ³ï¼ˆå¼·åˆ¶æ’­æ”¾ï¼Œä¸å—èªéŸ³é–‹é—œé™åˆ¶ï¼‰
        function speakWorkComplete() {
            console.log('ğŸ—£ï¸ speakWorkComplete è¢«èª¿ç”¨');
            
            const remaining = settings.dailyGoal - stats.todayCount;
            let message = `æ­å–œå®Œæˆä¸€å€‹ç•ªèŒ„ï¼ä»Šå¤©å·²å®Œæˆ ${stats.todayCount} å€‹`;
            
            if (remaining > 0) {
                message += `ï¼Œè·é›¢ç›®æ¨™é‚„æœ‰ ${remaining} å€‹`;
            } else if (remaining === 0) {
                message += `ï¼Œæ­å–œé”æˆä»Šæ—¥ç›®æ¨™ï¼`;
            } else {
                message += `ï¼Œè¶…è¶Šç›®æ¨™ ${Math.abs(remaining)} å€‹ï¼Œå¤ªæ£’äº†ï¼`;
            }
            
            // åŠ å…¥é¼“å‹µèª
            const encouragements = [
                'ç¹¼çºŒåŠ æ²¹ï¼',
                'ä¼‘æ¯ä¸€ä¸‹å§ï¼',
                'åšå¾—å¥½ï¼',
                'ä¿æŒå°ˆæ³¨ï¼',
                'ä½ å¾ˆæ£’ï¼'
            ];
            message += encouragements[Math.floor(Math.random() * encouragements.length)];
            
            console.log('ğŸ—£ï¸ èªéŸ³è¨Šæ¯:', message);
            
            // å…ˆå˜—è©¦å–šé†’èªéŸ³å¼•æ“
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                if (speechSynthesis.paused) {
                    speechSynthesis.resume();
                }
            }
            
            speakForce(message);
            
            // åŒæ­¥ç™¼é€ LINE é€šçŸ¥
            sendLineNotifyNow('work');
        }

        // ä¼‘æ¯çµæŸèªéŸ³ï¼ˆå¼·åˆ¶æ’­æ”¾ï¼‰
        function speakRestComplete() {
            const remaining = settings.dailyGoal - stats.todayCount;
            let message = 'ä¼‘æ¯çµæŸï¼Œæº–å‚™é–‹å§‹å·¥ä½œ';
            
            if (remaining > 0) {
                message += `ã€‚é‚„éœ€è¦ ${remaining} å€‹ç•ªèŒ„é”æˆä»Šæ—¥ç›®æ¨™`;
            } else {
                message += `ã€‚ä»Šæ—¥ç›®æ¨™å·²é”æˆï¼Œç¹¼çºŒæŒ‘æˆ°è‡ªå·±å§`;
            }
            
            console.log('ğŸ—£ï¸ æ’­æ”¾ä¼‘æ¯çµæŸèªéŸ³:', message);
            speakForce(message);
            
            // åŒæ­¥ç™¼é€ LINE é€šçŸ¥
            sendLineNotifyNow('rest');
        }
        
        // ç›´æ¥ç™¼é€ LINE é€šçŸ¥ï¼ˆä¸é€é GAS è§¸ç™¼å™¨ï¼‰
        function sendLineNotifyNow(phase) {
            if (!settings.gasUrl) return;
            
            const data = {
                action: 'sendNow',
                phase: phase,
                todayCount: stats.todayCount,
                dailyGoal: settings.dailyGoal
            };
            
            console.log('ğŸ“¤ ç›´æ¥ç™¼é€ LINE é€šçŸ¥:', data);
            
            fetch(settings.gasUrl, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).catch(error => {
                console.error('âŒ LINE é€šçŸ¥ç™¼é€å¤±æ•—:', error);
            });
        }

        // æ•´é»æé†’èªéŸ³ï¼ˆå¼·åˆ¶æ’­æ”¾ï¼‰
        function speakHourlyReminder() {
            const now = new Date();
            const hour = now.getHours();
            let timeDesc = '';
            
            if (hour < 12) {
                timeDesc = 'ä¸Šåˆ';
            } else if (hour < 18) {
                timeDesc = 'ä¸‹åˆ';
            } else {
                timeDesc = 'æ™šä¸Š';
            }
            
            const remaining = settings.dailyGoal - stats.todayCount;
            let message = `${timeDesc}å¥½ï¼æ•´é»ä¼‘æ¯æ™‚é–“åˆ°äº†ã€‚ä»Šå¤©å·²å®Œæˆ ${stats.todayCount} å€‹ç•ªèŒ„`;
            
            if (remaining > 0) {
                message += `ï¼Œé‚„éœ€è¦ ${remaining} å€‹é”æˆç›®æ¨™`;
            } else {
                message += `ï¼Œå·²è¶…è¶Šç›®æ¨™ï¼`;
            }
            
            speakForce(message);  // å¼·åˆ¶æ’­æ”¾
        }
        
        // å¼·åˆ¶æ’­æ”¾èªéŸ³ï¼ˆæ ¹æ“šè¨­å®šä½¿ç”¨ä¸åŒæœå‹™ï¼‰
        function speakForce(text) {
            console.log('ğŸ—£ï¸ speakForce è¢«èª¿ç”¨');
            console.log('ğŸ—£ï¸ èªéŸ³æœå‹™:', settings.voiceService);
            console.log('ğŸ—£ï¸ æ–‡å­—:', text.substring(0, 50) + '...');
            
            // é¡¯ç¤º Toast ç¢ºèªèªéŸ³è¢«è§¸ç™¼
            showToast('ğŸ—£ï¸ æ’­æ”¾èªéŸ³ä¸­...');
            
            try {
                switch (settings.voiceService) {
                    case 'gemini':
                        if (settings.geminiApiKey) {
                            console.log('ğŸ¤– ä½¿ç”¨ Gemini TTS');
                            speakWithGemini(text);
                        } else {
                            console.log('âš ï¸ Gemini API Key æœªè¨­å®šï¼Œä½¿ç”¨ Web Speech');
                            speakWithWebAPI(text);
                        }
                        break;
                    case 'elevenlabs':
                        if (settings.elevenlabsApiKey) {
                            console.log('ğŸ­ ä½¿ç”¨ ElevenLabs TTS');
                            speakWithElevenLabs(text);
                        } else {
                            console.log('âš ï¸ ElevenLabs API Key æœªè¨­å®šï¼Œä½¿ç”¨ Web Speech');
                            speakWithWebAPI(text);
                        }
                        break;
                    case 'web':
                    default:
                        console.log('ğŸŒ ä½¿ç”¨ Web Speech API');
                        speakWithWebAPI(text);
                        break;
                }
            } catch (error) {
                console.error('âŒ speakForce éŒ¯èª¤:', error);
                showToast('âŒ èªéŸ³æ’­æ”¾å¤±æ•—');
                // Fallback åˆ° Web Speech
                speakWithWebAPI(text);
            }
        }
        
        // Web Speech APIï¼ˆå…è²»ï¼Œå…§å»ºï¼‰
        function speakWithWebAPI(text) {
            console.log('ğŸŒ speakWithWebAPI è¢«èª¿ç”¨');
            console.log('ğŸŒ æ–‡å­—:', text);
            
            if (!('speechSynthesis' in window)) {
                console.log('âŒ æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Web Speech API');
                showToast('âŒ ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³');
                return;
            }
            
            // å…ˆå–šé†’èªéŸ³å¼•æ“
            try {
                if (speechSynthesis.paused) {
                    console.log('ğŸŒ èªéŸ³å¼•æ“æš«åœä¸­ï¼Œå˜—è©¦æ¢å¾©');
                    speechSynthesis.resume();
                }
                speechSynthesis.cancel();
            } catch (e) {
                console.log('ğŸŒ å–šé†’èªéŸ³å¼•æ“å¤±æ•—:', e);
            }
            
            const doSpeak = () => {
                console.log('ğŸŒ doSpeak åŸ·è¡Œ');
                
                try {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'zh-TW';
                    utterance.rate = 0.9;
                    utterance.volume = 1.0;
                    
                    // æ ¹æ“šæ€§åˆ¥é¸æ“‡èªéŸ³
                    const voices = speechSynthesis.getVoices();
                    console.log('ğŸŒ å¯ç”¨èªéŸ³æ•¸:', voices.length);
                    
                    if (voices.length > 0) {
                        const zhVoices = voices.filter(v => 
                            v.lang.includes('zh-TW') || v.lang.includes('zh_TW') ||
                            v.lang.includes('zh-CN') || v.lang.includes('zh_CN') || v.lang.includes('cmn')
                        );
                        console.log('ğŸŒ ä¸­æ–‡èªéŸ³æ•¸:', zhVoices.length);
                        
                        if (zhVoices.length > 0) {
                            const preferredVoice = zhVoices.find(v => {
                                const name = v.name.toLowerCase();
                                if (settings.voiceGender === 'female') {
                                    return name.includes('female') || name.includes('å¥³') || name.includes('mei') || name.includes('ting');
                                } else {
                                    return name.includes('male') || name.includes('ç”·') || !name.includes('female');
                                }
                            }) || zhVoices[0];
                            utterance.voice = preferredVoice;
                            console.log('ğŸŒ ä½¿ç”¨èªéŸ³:', preferredVoice.name);
                        }
                    }
                    
                    utterance.onstart = () => {
                        console.log('ğŸ—£ï¸ Web Speech é–‹å§‹æ’­æ”¾');
                        showToast('ğŸ—£ï¸ èªéŸ³æ’­æ”¾ä¸­');
                    };
                    utterance.onerror = (e) => {
                        console.log('ğŸ—£ï¸ Web Speech éŒ¯èª¤:', e.error);
                        showToast('âŒ èªéŸ³éŒ¯èª¤: ' + e.error);
                    };
                    utterance.onend = () => {
                        console.log('ğŸ—£ï¸ Web Speech æ’­æ”¾å®Œæˆ');
                    };
                    
                    speechSynthesis.speak(utterance);
                    console.log('ğŸŒ å·²æ’å…¥èªéŸ³ä½‡åˆ—');
                    
                    // æª¢æŸ¥æ˜¯å¦çœŸçš„åœ¨æ’­æ”¾
                    setTimeout(() => {
                        if (speechSynthesis.speaking) {
                            console.log('ğŸŒ ç¢ºèªï¼šèªéŸ³æ­£åœ¨æ’­æ”¾');
                        } else if (speechSynthesis.pending) {
                            console.log('ğŸŒ ç¢ºèªï¼šèªéŸ³åœ¨ä½‡åˆ—ä¸­');
                        } else {
                            console.log('ğŸŒ è­¦å‘Šï¼šèªéŸ³å¯èƒ½æ²’æœ‰æ’­æ”¾ï¼Œå˜—è©¦é‡è©¦');
                            // é‡è©¦ä¸€æ¬¡
                            speechSynthesis.speak(utterance);
                        }
                    }, 500);
                    
                } catch (error) {
                    console.error('ğŸŒ doSpeak éŒ¯èª¤:', error);
                    showToast('âŒ èªéŸ³æ’­æ”¾å¤±æ•—');
                }
            };
            
            const voices = speechSynthesis.getVoices();
            if (voices.length === 0) {
                console.log('ğŸŒ ç­‰å¾…èªéŸ³è¼‰å…¥...');
                speechSynthesis.addEventListener('voiceschanged', () => {
                    console.log('ğŸŒ èªéŸ³å·²è¼‰å…¥');
                    doSpeak();
                }, { once: true });
                speechSynthesis.getVoices();
                // å¦‚æœ 1 ç§’å¾Œé‚„æ²’è¼‰å…¥ï¼Œå¼·åˆ¶åŸ·è¡Œ
                setTimeout(() => {
                    const v = speechSynthesis.getVoices();
                    console.log('ğŸŒ 1ç§’å¾Œæª¢æŸ¥ï¼ŒèªéŸ³æ•¸:', v.length);
                    if (v.length > 0 || true) {
                        doSpeak();
                    }
                }, 1000);
            } else {
                doSpeak();
            }
        }
        
        // Google Gemini TTS
        async function speakWithGemini(text) {
            if (!settings.geminiApiKey) {
                console.log('âŒ æœªè¨­å®š Gemini API Keyï¼Œä½¿ç”¨ Web Speech');
                speakWithWebAPI(text);
                return;
            }
            
            try {
                // ä½¿ç”¨é¸æ“‡çš„èªéŸ³
                const voiceName = settings.geminiVoice || 'Zephyr';
                console.log('ğŸ¤– Gemini èªéŸ³:', voiceName);
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${settings.geminiApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: text }]
                        }],
                        generationConfig: {
                            response_modalities: ["AUDIO"],
                            speech_config: {
                                voice_config: {
                                    prebuilt_voice_config: {
                                        voice_name: voiceName
                                    }
                                }
                            }
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Gemini API éŒ¯èª¤: ${response.status}`);
                }
                
                const data = await response.json();
                
                // æª¢æŸ¥æ˜¯å¦æœ‰éŸ³é »æ•¸æ“š
                if (data.candidates && data.candidates[0]?.content?.parts) {
                    const audioPart = data.candidates[0].content.parts.find(p => p.inlineData?.mimeType?.includes('audio'));
                    if (audioPart) {
                        const audioData = audioPart.inlineData.data;
                        const audioBlob = base64ToBlob(audioData, audioPart.inlineData.mimeType);
                        const audioUrl = URL.createObjectURL(audioBlob);
                        const audio = new Audio(audioUrl);
                        audio.play();
                        console.log('ğŸ¤– Gemini TTS æ’­æ”¾ä¸­');
                        return;
                    }
                }
                
                throw new Error('Gemini æœªè¿”å›éŸ³é »');
                
            } catch (error) {
                console.error('âŒ Gemini TTS éŒ¯èª¤:', error);
                showToast('Gemini èªéŸ³å¤±æ•—ï¼Œä½¿ç”¨ Web Speech');
                speakWithWebAPI(text);
            }
        }
        
        // ElevenLabs TTS
        async function speakWithElevenLabs(text) {
            if (!settings.elevenlabsApiKey) {
                console.log('âŒ æœªè¨­å®š ElevenLabs API Keyï¼Œä½¿ç”¨ Web Speech');
                speakWithWebAPI(text);
                return;
            }
            
            try {
                // ä½¿ç”¨é¸æ“‡çš„èªéŸ³ ID
                const voiceId = settings.elevenlabsVoice || '21m00Tcm4TlvDq8ikWAM';
                console.log('ğŸ­ ElevenLabs èªéŸ³ ID:', voiceId);
                
                const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'audio/mpeg',
                        'Content-Type': 'application/json',
                        'xi-api-key': settings.elevenlabsApiKey
                    },
                    body: JSON.stringify({
                        text: text,
                        model_id: 'eleven_multilingual_v2',
                        voice_settings: {
                            stability: 0.5,
                            similarity_boost: 0.75
                        }
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`ElevenLabs API éŒ¯èª¤: ${response.status} - ${errorText}`);
                }
                
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                audio.play();
                console.log('ğŸ­ ElevenLabs TTS æ’­æ”¾ä¸­');
                
            } catch (error) {
                console.error('âŒ ElevenLabs TTS éŒ¯èª¤:', error);
                showToast('ElevenLabs èªéŸ³å¤±æ•—ï¼Œä½¿ç”¨ Web Speech');
                speakWithWebAPI(text);
            }
        }
        
        // Base64 è½‰ Blob å·¥å…·å‡½æ•¸
        function base64ToBlob(base64, mimeType) {
            const byteCharacters = atob(base64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray], { type: mimeType });
        }
        
        // èªéŸ³æœå‹™è¨­å®šå‡½æ•¸
        function setVoiceService(service) {
            settings.voiceService = service;
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.getElementById('voiceServiceWeb').style.borderColor = service === 'web' ? 'var(--accent)' : 'var(--bg-tertiary)';
            document.getElementById('voiceServiceGemini').style.borderColor = service === 'gemini' ? 'var(--accent)' : 'var(--bg-tertiary)';
            document.getElementById('voiceServiceElevenLabs').style.borderColor = service === 'elevenlabs' ? 'var(--accent)' : 'var(--bg-tertiary)';
            
            // é¡¯ç¤º/éš±è—å°æ‡‰å€å¡Š
            document.getElementById('webVoiceSection').style.display = service === 'web' ? 'flex' : 'none';
            document.getElementById('geminiKeySection').style.display = service === 'gemini' ? 'flex' : 'none';
            document.getElementById('elevenlabsKeySection').style.display = service === 'elevenlabs' ? 'flex' : 'none';
            
            console.log('ğŸ™ï¸ èªéŸ³æœå‹™:', service);
        }
        
        function setVoiceGender(gender) {
            settings.voiceGender = gender;
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.getElementById('voiceGenderFemale').style.borderColor = gender === 'female' ? 'var(--accent)' : 'var(--bg-tertiary)';
            document.getElementById('voiceGenderMale').style.borderColor = gender === 'male' ? 'var(--accent)' : 'var(--bg-tertiary)';
            
            console.log('ğŸ‘¤ èªéŸ³æ€§åˆ¥:', gender);
        }
        
        function saveVoiceSettings() {
            settings.geminiApiKey = document.getElementById('geminiApiKey').value.trim();
            settings.geminiVoice = document.getElementById('geminiVoice').value;
            settings.elevenlabsApiKey = document.getElementById('elevenlabsApiKey').value.trim();
            settings.elevenlabsVoice = document.getElementById('elevenlabsVoice').value;
            saveSettings();
            showToast('âœ… èªéŸ³è¨­å®šå·²å„²å­˜');
        }
        
        function testVoiceService() {
            let voiceInfo = '';
            if (settings.voiceService === 'web') {
                voiceInfo = `Web Speech ${settings.voiceGender === 'female' ? 'å¥³è²' : 'ç”·è²'}`;
            } else if (settings.voiceService === 'gemini') {
                voiceInfo = `Gemini ${settings.geminiVoice}`;
            } else {
                const voiceSelect = document.getElementById('elevenlabsVoice');
                const selectedOption = voiceSelect.options[voiceSelect.selectedIndex];
                voiceInfo = `ElevenLabs ${selectedOption.text.split('ï¼ˆ')[0]}`;
            }
            
            const testText = `èªéŸ³æ¸¬è©¦æˆåŠŸï¼ç›®å‰ä½¿ç”¨ ${voiceInfo}ã€‚ä»Šå¤©å·²å®Œæˆ ${stats.todayCount} å€‹ç•ªèŒ„ã€‚`;
            
            showToast('ğŸ™ï¸ æ¸¬è©¦èªéŸ³ä¸­...');
            speakForce(testText);
        }
        
        // æ¸¬è©¦èªéŸ³
        function testSpeech() {
            if (!('speechSynthesis' in window)) {
                showToast('âŒ æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³');
                return;
            }
            
            // é¡¯ç¤ºèªéŸ³ç‹€æ…‹
            const voices = speechSynthesis.getVoices();
            console.log('ğŸ—£ï¸ å¯ç”¨èªéŸ³æ•¸é‡:', voices.length);
            
            if (voices.length === 0) {
                // voices å¯èƒ½é‚„æ²’è¼‰å…¥ï¼Œç­‰å¾…ä¸€ä¸‹
                showToast('â³ èªéŸ³å¼•æ“è¼‰å…¥ä¸­...');
                speechSynthesis.addEventListener('voiceschanged', function onVoicesChanged() {
                    speechSynthesis.removeEventListener('voiceschanged', onVoicesChanged);
                    testSpeech();
                }, { once: true });
                
                // å¼·åˆ¶è§¸ç™¼ voices è¼‰å…¥
                speechSynthesis.getVoices();
                return;
            }
            
            // æ‰¾ä¸­æ–‡èªéŸ³
            const zhVoices = voices.filter(v => v.lang.includes('zh') || v.lang.includes('TW') || v.lang.includes('CN'));
            console.log('ğŸ—£ï¸ ä¸­æ–‡èªéŸ³:', zhVoices.map(v => v.name + ' (' + v.lang + ')'));
            
            speechSynthesis.cancel();
            
            const testText = `èªéŸ³æ¸¬è©¦æˆåŠŸï¼ä»Šå¤©å·²å®Œæˆ ${stats.todayCount} å€‹ç•ªèŒ„`;
            const utterance = new SpeechSynthesisUtterance(testText);
            utterance.lang = 'zh-TW';
            utterance.rate = 0.9;
            utterance.volume = 1.0;
            
            if (zhVoices.length > 0) {
                utterance.voice = zhVoices[0];
            }
            
            utterance.onstart = () => showToast('ğŸ—£ï¸ èªéŸ³æ’­æ”¾ä¸­...');
            utterance.onend = () => showToast('âœ… èªéŸ³æ¸¬è©¦å®Œæˆ');
            utterance.onerror = (e) => showToast('âŒ èªéŸ³éŒ¯èª¤: ' + e.error);
            
            speechSynthesis.speak(utterance);
        }
        
        // åˆå§‹åŒ–èªéŸ³å¼•æ“ï¼ˆè¼‰å…¥ voicesï¼‰
        function initSpeech() {
            if ('speechSynthesis' in window) {
                // é å…ˆè¼‰å…¥ voices
                speechSynthesis.getVoices();
                
                // ç›£è½ voices è®ŠåŒ–
                speechSynthesis.addEventListener('voiceschanged', () => {
                    const voices = speechSynthesis.getVoices();
                    console.log('ğŸ—£ï¸ èªéŸ³å¼•æ“å·²è¼‰å…¥ï¼Œå¯ç”¨èªéŸ³:', voices.length);
                });
            }
        }
        
        // iOS éœ€è¦ç”¨æˆ¶äº’å‹•æ‰èƒ½æ’­æ”¾èªéŸ³ï¼Œåœ¨ç¬¬ä¸€æ¬¡é»æ“Šæ™‚åˆå§‹åŒ–
        let speechInitialized = false;
        document.addEventListener('click', function initSpeechOnClick() {
            if (speechInitialized) return;
            if ('speechSynthesis' in window) {
                // æ’­æ”¾ä¸€å€‹ç©ºçš„èªéŸ³ä¾†è§£é–
                const unlock = new SpeechSynthesisUtterance('');
                unlock.volume = 0;
                speechSynthesis.speak(unlock);
                speechInitialized = true;
                console.log('ğŸ—£ï¸ èªéŸ³å¼•æ“å·²è§£é–ï¼ˆç”¨æˆ¶äº’å‹•ï¼‰');
            }
        }, { once: true });

        // ============================================
        // é€šçŸ¥
        // ============================================
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        function sendNotification(title, body) {
            if (settings.notification && 'Notification' in window && Notification.permission === 'granted') {
                new Notification(title, { body, icon: 'ğŸ…' });
            }
        }

        // ============================================
        // GAS ä¼ºæœå™¨ç«¯è¨ˆæ™‚ï¼ˆä¼‘çœ æ™‚ä¹Ÿèƒ½é€šçŸ¥ï¼‰
        // ============================================
        function sendTimerToGAS(phase, minutes) {
            if (!settings.gasUrl) {
                console.log('âš ï¸ æœªè¨­å®š GAS URLï¼Œè·³éä¼ºæœå™¨ç«¯è¨ˆæ™‚');
                return;
            }
            
            const data = {
                action: 'startTimer',
                phase: phase,
                minutes: minutes,
                todayCount: stats.todayCount,
                dailyGoal: settings.dailyGoal
            };
            
            console.log('ğŸ“¤ ç™¼é€è¨ˆæ™‚åˆ° GAS:', data);
            
            fetch(settings.gasUrl, {
                method: 'POST',
                mode: 'no-cors',  // GAS éœ€è¦
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(() => {
                console.log('âœ… GAS è¨ˆæ™‚å™¨å·²è¨­å®š');
                showToast(`ğŸ“¡ LINE å°‡åœ¨ ${minutes} åˆ†é˜å¾Œé€šçŸ¥`);
            })
            .catch(error => {
                console.error('âŒ GAS ç™¼é€å¤±æ•—:', error);
            });
        }
        
        function cancelGASTimer() {
            if (!settings.gasUrl) return;
            
            fetch(settings.gasUrl, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ action: 'cancelTimer' })
            })
            .then(() => {
                console.log('â¹ï¸ GAS è¨ˆæ™‚å™¨å·²å–æ¶ˆ');
            })
            .catch(error => {
                console.error('âŒ GAS å–æ¶ˆå¤±æ•—:', error);
            });
        }
        
        function testGASNotify() {
            if (!settings.gasUrl) {
                showToast('âŒ è«‹å…ˆè¨­å®š GAS URL');
                return;
            }
            
            showToast('ğŸ“¤ ç™¼é€æ¸¬è©¦é€šçŸ¥...');
            
            fetch(settings.gasUrl, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ action: 'testNotify' })
            })
            .then(() => {
                showToast('âœ… æ¸¬è©¦è«‹æ±‚å·²ç™¼é€ï¼Œè«‹æª¢æŸ¥ LINE');
            })
            .catch(error => {
                console.error('âŒ æ¸¬è©¦å¤±æ•—:', error);
                showToast('âŒ æ¸¬è©¦å¤±æ•—: ' + error.message);
            });
        }

        // ============================================
        // è¨­å®š
        // ============================================
        function toggleSwitch(type) {
            const switchEl = document.getElementById('switch' + type.charAt(0).toUpperCase() + type.slice(1));
            switchEl.classList.toggle('active');
            settings[type] = switchEl.classList.contains('active');
            saveSettings();
        }

        function setTheme(theme) {
            settings.theme = theme;
            document.querySelectorAll('.theme-option').forEach(t => t.classList.remove('active'));
            // æ‰¾åˆ°å°æ‡‰çš„æŒ‰éˆ•ä¸¦åŠ ä¸Š active
            document.querySelectorAll('.theme-option').forEach(t => {
                if (t.classList.contains(theme)) {
                    t.classList.add('active');
                }
            });
            
            if (theme === 'dark') {
                document.body.removeAttribute('data-theme');
            } else {
                document.body.setAttribute('data-theme', theme);
            }
            saveSettings();
        }

        // ============================================
        // Wake Lock APIï¼ˆè¢å¹•é•·äº®ï¼‰
        // ============================================
        let wakeLock = null;

        async function requestWakeLock() {
            if (!('wakeLock' in navigator)) {
                console.log('âŒ æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Wake Lock API');
                showToast('âŒ æ­¤è£ç½®ä¸æ”¯æ´è¢å¹•é•·äº®åŠŸèƒ½');
                return false;
            }
            
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log('ğŸ”† è¢å¹•é•·äº®å·²å•Ÿç”¨');
                
                wakeLock.addEventListener('release', () => {
                    console.log('ğŸ”… è¢å¹•é•·äº®å·²é‡‹æ”¾');
                    updateWakeLockStatus(false);
                });
                
                updateWakeLockStatus(true);
                return true;
            } catch (err) {
                console.log('Wake Lock è«‹æ±‚å¤±æ•—:', err);
                showToast('âŒ ç„¡æ³•å•Ÿç”¨è¢å¹•é•·äº®ï¼š' + err.message);
                return false;
            }
        }

        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
                console.log('ğŸ”… æ‰‹å‹•é‡‹æ”¾è¢å¹•é•·äº®');
            }
            updateWakeLockStatus(false);
        }

        function updateWakeLockStatus(active) {
            const statusEl = document.getElementById('wakeLockStatus');
            if (statusEl) {
                if (active) {
                    statusEl.textContent = 'ğŸ”† è¢å¹•é•·äº®å·²å•Ÿç”¨ï¼ˆè¨ˆæ™‚ä¸­ä¿æŒï¼‰';
                    statusEl.style.display = 'block';
                    statusEl.style.color = 'var(--accent)';
                } else {
                    statusEl.style.display = 'none';
                }
            }
        }

        function setScreenMode(mode) {
            settings.screenMode = mode;
            
            // æ›´æ–° UI
            document.getElementById('modeBackground').style.borderColor = mode === 'background' ? 'var(--accent)' : 'var(--bg-tertiary)';
            document.getElementById('modeAwake').style.borderColor = mode === 'awake' ? 'var(--accent)' : 'var(--bg-tertiary)';
            
            if (mode === 'awake') {
                // å¦‚æœè¨ˆæ™‚ä¸­ï¼Œç«‹å³å•Ÿç”¨
                if (timerState.isRunning) {
                    requestWakeLock();
                }
                showToast('â˜€ï¸ è¢å¹•é•·äº®æ¨¡å¼ï¼šè¨ˆæ™‚æ™‚è¢å¹•ä¸æœƒä¼‘çœ ');
            } else {
                releaseWakeLock();
                showToast('ğŸŒ™ èƒŒæ™¯åŸ·è¡Œæ¨¡å¼ï¼šçœé›»ä½†å–šé†’å¯èƒ½å»¶é²');
            }
            
            saveSettings();
        }

        // è¨ˆæ™‚é–‹å§‹æ™‚æ ¹æ“šè¨­å®šå•Ÿç”¨ Wake Lock
        function handleWakeLockOnTimerStart() {
            if (settings.screenMode === 'awake') {
                requestWakeLock();
            }
        }

        // è¨ˆæ™‚çµæŸæ™‚é‡‹æ”¾ Wake Lock
        function handleWakeLockOnTimerStop() {
            if (settings.screenMode === 'awake' && wakeLock) {
                // å»¶é²é‡‹æ”¾ï¼Œè®“ç”¨æˆ¶çœ‹åˆ°çµæœ
                setTimeout(() => {
                    if (!timerState.isRunning) {
                        releaseWakeLock();
                    }
                }, 5000);
            }
        }

        // é é¢å¯è¦‹æ™‚é‡æ–°è«‹æ±‚ Wake Lockï¼ˆç³»çµ±å¯èƒ½æœƒè‡ªå‹•é‡‹æ”¾ï¼‰
        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'visible') {
                if (settings.screenMode === 'awake' && timerState.isRunning && !wakeLock) {
                    await requestWakeLock();
                }
            }
        });

        function loadSettings() {
            const saved = localStorage.getItem('pomodoroProSettings');
            if (saved) {
                settings = { ...settings, ...JSON.parse(saved) };
            }

            // æ›´æ–° UI
            document.getElementById('workDuration').value = settings.workDuration;
            document.getElementById('shortBreak').value = settings.shortBreak;
            document.getElementById('longBreak').value = settings.longBreak;
            document.getElementById('longBreakInterval').value = settings.longBreakInterval;
            document.getElementById('hourlyMinute').value = settings.hourlyMinute;
            document.getElementById('classTime').value = settings.classTime;
            document.getElementById('breakTime').value = settings.breakTime;
            document.getElementById('sleepStart').value = settings.sleepStart;
            document.getElementById('sleepEnd').value = settings.sleepEnd;
            document.getElementById('sleepReminder').value = settings.sleepReminder;
            document.getElementById('gasUrl').value = settings.gasUrl || '';

            document.getElementById('switchNotification').classList.toggle('active', settings.notification);
            document.getElementById('switchSound').classList.toggle('active', settings.sound);
            document.getElementById('switchVoice').classList.toggle('active', settings.voice);
            document.getElementById('switchVibrate').classList.toggle('active', settings.vibrate);
            
            // æ¯æ—¥ç›®æ¨™
            document.getElementById('dailyGoal').value = settings.dailyGoal;

            // ä¸»é¡Œ
            if (settings.theme !== 'dark') {
                document.body.setAttribute('data-theme', settings.theme);
            }
            document.querySelectorAll('.theme-option').forEach(t => {
                t.classList.toggle('active', t.classList.contains(settings.theme));
            });

            // é˜è² - ä½¿ç”¨ onclick å±¬æ€§ä¾†åŒ¹é…
            document.querySelectorAll('.chime-option').forEach(btn => {
                const onclick = btn.getAttribute('onclick') || '';
                const match = onclick.match(/setChime\('([^']+)'\)/);
                if (match) {
                    btn.classList.toggle('active', match[1] === settings.chime);
                }
            });

            // åŸ·è¡Œæ¨¡å¼
            if (settings.screenMode === 'awake') {
                document.getElementById('modeBackground').style.borderColor = 'var(--bg-tertiary)';
                document.getElementById('modeAwake').style.borderColor = 'var(--accent)';
            } else {
                document.getElementById('modeBackground').style.borderColor = 'var(--accent)';
                document.getElementById('modeAwake').style.borderColor = 'var(--bg-tertiary)';
            }

            // èªéŸ³æœå‹™è¨­å®š
            setVoiceService(settings.voiceService || 'web');
            setVoiceGender(settings.voiceGender || 'female');
            document.getElementById('geminiApiKey').value = settings.geminiApiKey || '';
            document.getElementById('geminiVoice').value = settings.geminiVoice || 'Zephyr';
            document.getElementById('elevenlabsApiKey').value = settings.elevenlabsApiKey || '';
            document.getElementById('elevenlabsVoice').value = settings.elevenlabsVoice || '21m00Tcm4TlvDq8ikWAM';

            // æ›´æ–°è¨ˆæ™‚å™¨
            timerState.timeLeft = settings.workDuration * 60;
            timerState.totalTime = settings.workDuration * 60;

            document.getElementById('soundBtn').textContent = settings.sound ? 'ğŸ””' : 'ğŸ”•';
        }

        function saveSettings() {
            settings.workDuration = parseInt(document.getElementById('workDuration').value) || 25;
            settings.shortBreak = parseInt(document.getElementById('shortBreak').value) || 5;
            settings.longBreak = parseInt(document.getElementById('longBreak').value) || 15;
            settings.longBreakInterval = parseInt(document.getElementById('longBreakInterval').value) || 4;
            settings.hourlyMinute = parseInt(document.getElementById('hourlyMinute').value) || 55;
            settings.classTime = parseInt(document.getElementById('classTime').value) || 45;
            settings.breakTime = parseInt(document.getElementById('breakTime').value) || 10;
            settings.sleepStart = document.getElementById('sleepStart').value || '00:00';
            settings.sleepEnd = document.getElementById('sleepEnd').value || '06:00';
            settings.sleepReminder = document.getElementById('sleepReminder').value || '21:45';

            localStorage.setItem('pomodoroProSettings', JSON.stringify(settings));
        }

        function saveAllSettings() {
            saveSettings();
            
            if (!timerState.isRunning) {
                if (timerState.mode === 'countdown') {
                    timerState.timeLeft = settings.workDuration * 60;
                    timerState.totalTime = settings.workDuration * 60;
                } else if (timerState.mode === 'classroom') {
                    timerState.timeLeft = settings.classTime * 60;
                    timerState.totalTime = settings.classTime * 60;
                }
                updateTimerDisplay();
            }

            showToast('âœ… è¨­å®šå·²å„²å­˜');
        }

        function saveGasUrl() {
            settings.gasUrl = document.getElementById('gasUrl').value.trim();
            saveSettings();
            showToast('âœ… GAS URL å·²å„²å­˜');
        }

        async function testGas() {
            const url = settings.gasUrl;
            if (!url) {
                showToast('âŒ è«‹å…ˆå¡«å…¥ GAS URL');
                return;
            }
            
            showToast('ğŸ“¤ æ­£åœ¨ç™¼é€ LINE æ¸¬è©¦é€šçŸ¥...');
            
            try {
                // ä½¿ç”¨ no-cors æ¨¡å¼ï¼ˆGAS éœ€è¦ï¼‰
                await fetch(url, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'testNotify' })
                });
                
                showToast('âœ… æ¸¬è©¦è«‹æ±‚å·²ç™¼é€ï¼Œè«‹æª¢æŸ¥ LINEï¼');
            } catch (error) {
                console.error('GAS æ¸¬è©¦éŒ¯èª¤:', error);
                showToast('âŒ é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ URL');
            }
        }

        // ============================================
        // çµ±è¨ˆ
        // ============================================
        function loadStats() {
            const saved = localStorage.getItem('pomodoroProStats');
            if (saved) {
                stats = { ...stats, ...JSON.parse(saved) };
            }

            const today = new Date().toDateString();
            if (stats.lastDate !== today) {
                // å„²å­˜æ˜¨å¤©çš„è³‡æ–™åˆ°æ­·å²
                if (stats.lastDate && stats.todayCount > 0) {
                    stats.history.push({
                        date: formatDate(new Date(stats.lastDate)),
                        count: stats.todayCount,
                        minutes: stats.todayMinutes
                    });
                    
                    // æ›´æ–°é€±æ•¸æ“š
                    stats.weeklyData.shift();
                    stats.weeklyData.push(stats.todayMinutes);

                    // æª¢æŸ¥é€£çºŒå¤©æ•¸
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    if (stats.lastDate === yesterday.toDateString()) {
                        stats.streak++;
                        if (stats.streak > stats.bestStreak) {
                            stats.bestStreak = stats.streak;
                        }
                    } else {
                        stats.streak = 0;
                    }
                }

                stats.lastDate = today;
                stats.todayCount = 0;
                stats.todayMinutes = 0;
                saveStats();
            }
        }

        function saveStats() {
            localStorage.setItem('pomodoroProStats', JSON.stringify(stats));
        }

        // ============================================
        // è¨ˆæ™‚ç‹€æ…‹ä¿å­˜ï¼ˆç”¨æ–¼èƒŒæ™¯æ¢å¾©ï¼‰
        // ============================================
        function saveTimerState() {
            if (timerState.isRunning && timerState.endTime) {
                const stateToSave = {
                    mode: timerState.mode,
                    phase: timerState.phase,
                    endTime: timerState.endTime,
                    totalTime: timerState.totalTime,
                    pomodoroCount: timerState.pomodoroCount,
                    sessionCount: timerState.sessionCount
                };
                localStorage.setItem('pomodoroProTimerState', JSON.stringify(stateToSave));
                console.log('ğŸ’¾ è¨ˆæ™‚ç‹€æ…‹å·²ä¿å­˜');
            }
        }

        function loadTimerState() {
            const saved = localStorage.getItem('pomodoroProTimerState');
            if (!saved) return;
            
            try {
                const state = JSON.parse(saved);
                const now = Date.now();
                const remaining = Math.ceil((state.endTime - now) / 1000);
                
                console.log('ğŸ“‚ è¼‰å…¥è¨ˆæ™‚ç‹€æ…‹, å‰©é¤˜:', remaining, 'ç§’');
                
                if (remaining > 0) {
                    // è¨ˆæ™‚é‚„æ²’çµæŸï¼Œæ¢å¾©ç‹€æ…‹
                    timerState.mode = state.mode;
                    timerState.phase = state.phase;
                    timerState.endTime = state.endTime;
                    timerState.totalTime = state.totalTime;
                    timerState.timeLeft = remaining;
                    timerState.pomodoroCount = state.pomodoroCount || 0;
                    timerState.sessionCount = state.sessionCount || 0;
                    timerState.isRunning = true;
                    
                    // é‡æ–°å•Ÿå‹•è¨ˆæ™‚å™¨
                    updateTimerDisplay();
                    updateTimerStyle();
                    updateStartButton();
                    
                    if (timerState.phase !== 'work') {
                        showRestModal();
                        startBreathingAnimation();
                    }
                    
                    // é‡æ–°å•Ÿå‹• interval
                    timerInterval = setInterval(() => {
                        const now = Date.now();
                        const remaining = Math.max(0, Math.ceil((timerState.endTime - now) / 1000));
                        timerState.timeLeft = remaining;
                        updateTimerDisplay();
                        
                        if (timerState.phase !== 'work') {
                            updateRestModalTimer();
                        }
                        
                        if (timerState.timeLeft <= 0) {
                            handleTimerComplete();
                        }
                    }, 1000);
                    
                    showToast(`â±ï¸ æ¢å¾©è¨ˆæ™‚ä¸­ï¼Œå‰©é¤˜ ${Math.floor(remaining/60)}:${(remaining%60).toString().padStart(2,'0')}`);
                    
                } else if (remaining <= 0 && remaining > -3600) {
                    // è¨ˆæ™‚å·²çµæŸï¼ˆ1å°æ™‚å…§ï¼‰ï¼Œè§¸ç™¼å®Œæˆ
                    timerState.mode = state.mode;
                    timerState.phase = state.phase;
                    timerState.totalTime = state.totalTime;
                    timerState.pomodoroCount = state.pomodoroCount || 0;
                    timerState.sessionCount = state.sessionCount || 0;
                    timerState.timeLeft = 0;
                    
                    console.log('â° èƒŒæ™¯è¨ˆæ™‚å·²å®Œæˆï¼Œè§¸ç™¼å®Œæˆé‚è¼¯');
                    handleTimerComplete();
                }
                
                // æ¸…é™¤ä¿å­˜çš„ç‹€æ…‹
                clearTimerState();
                
            } catch (e) {
                console.log('è¼‰å…¥è¨ˆæ™‚ç‹€æ…‹å¤±æ•—:', e);
                clearTimerState();
            }
        }

        function clearTimerState() {
            localStorage.removeItem('pomodoroProTimerState');
        }

        // é é¢é—œé–‰å‰ä¿å­˜ç‹€æ…‹
        window.addEventListener('beforeunload', function() {
            if (timerState.isRunning && timerState.endTime) {
                saveTimerState();
            }
        });

        // é é¢éš±è—æ™‚ä¿å­˜ç‹€æ…‹ï¼ˆæ‰‹æ©Ÿåˆ‡æ› appï¼‰
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') {
                if (timerState.isRunning && timerState.endTime) {
                    saveTimerState();
                }
            }
        });

        function formatDate(date) {
            return `${date.getMonth() + 1}/${date.getDate()}`;
        }

        // ============================================
        // å¾…è¾¦äº‹é …å„²å­˜
        // ============================================
        function loadTodos() {
            const saved = localStorage.getItem('pomodoroProTodos');
            if (saved) {
                todos = JSON.parse(saved);
            }
        }

        function saveTodos() {
            localStorage.setItem('pomodoroProTodos', JSON.stringify(todos));
        }

        // ============================================
        // åŒ¯å‡ºçµ±è¨ˆ
        // ============================================
        function exportStats() {
            let csv = 'æ—¥æœŸ,ç•ªèŒ„æ•¸,å°ˆæ³¨åˆ†é˜\n';
            stats.history.forEach(item => {
                csv += `${item.date},${item.count},${item.minutes}\n`;
            });
            csv += `ä»Šæ—¥,${stats.todayCount},${stats.todayMinutes}\n`;

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ç•ªèŒ„é˜çµ±è¨ˆ_${new Date().toLocaleDateString()}.csv`;
            link.click();

            showToast('ğŸ“¤ çµ±è¨ˆå·²åŒ¯å‡º');
        }

        // ============================================
        // å…¨è¢å¹•
        // ============================================
        function toggleFullscreen() {
            const isFullscreen = document.body.classList.contains('fullscreen-mode');
            
            if (!isFullscreen) {
                // é€²å…¥å…¨è¢å¹•æ¨¡å¼
                document.body.classList.add('fullscreen-mode');
                
                // å˜—è©¦ä½¿ç”¨åŸç”Ÿå…¨è¢å¹• APIï¼ˆæ¡Œé¢ç€è¦½å™¨ï¼‰
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen().catch(() => {});
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen();
                }
                
                showToast('â›¶ å…¨è¢å¹•æ¨¡å¼ï¼ˆé»æ“Šè¨ˆæ™‚å™¨é€€å‡ºï¼‰');
            } else {
                // é€€å‡ºå…¨è¢å¹•æ¨¡å¼
                document.body.classList.remove('fullscreen-mode');
                
                if (document.exitFullscreen) {
                    document.exitFullscreen().catch(() => {});
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                }
                
                showToast('é€€å‡ºå…¨è¢å¹•');
            }
        }

        function exitFullscreenOnClick() {
            // åªåœ¨å…¨è¢å¹•æ¨¡å¼ä¸‹é»æ“Šè¨ˆæ™‚å™¨æ‰é€€å‡º
            if (document.body.classList.contains('fullscreen-mode')) {
                toggleFullscreen();
            }
        }

        // ============================================
        // å¿«æ·éµ
        // ============================================
        function bindKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // å¿½ç•¥è¼¸å…¥æ¡†
                if (e.target.tagName === 'INPUT') return;

                switch (e.code) {
                    case 'Space':
                        e.preventDefault();
                        toggleTimer();
                        break;
                    case 'KeyR':
                        resetTimer();
                        break;
                    case 'KeyF':
                        toggleFullscreen();
                        break;
                    case 'KeyM':
                        toggleSound();
                        break;
                    case 'Escape':
                        if (document.body.classList.contains('fullscreen-mode')) {
                            toggleFullscreen();
                        }
                        break;
                }
            });
        }

        function showShortcuts() {
            showToast('âŒ¨ï¸ Space:é–‹å§‹ | R:é‡ç½® | F:å…¨è¢å¹• | M:éœéŸ³');
        }

        function toggleSound() {
            settings.sound = !settings.sound;
            document.getElementById('soundBtn').textContent = settings.sound ? 'ğŸ””' : 'ğŸ”•';
            document.getElementById('switchSound').classList.toggle('active', settings.sound);
            showToast(settings.sound ? 'ğŸ”” éŸ³æ•ˆå·²é–‹å•Ÿ' : 'ğŸ”• éŸ³æ•ˆå·²é—œé–‰');
            saveSettings();
        }

        // ============================================
        // æ¸¬è©¦ä¼‘æ¯å€’æ•¸
        // ============================================
        function testRestCountdown() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            switchPage('timer');
            document.querySelectorAll('.tab-item')[0].classList.add('active');
            
            playSound();

            timerState.phase = 'rest';
            timerState.isRunning = true;
            timerState.timeLeft = 10;
            timerState.totalTime = 10;
            timerState.endTime = Date.now() + 10 * 1000;

            document.getElementById('timerLabel').textContent = 'æ¸¬è©¦ä¼‘æ¯';
            updateTimerDisplay();
            updateTimerStyle();
            showRestModal();

            timerInterval = setInterval(function() {
                // ç”¨æ™‚é–“æˆ³è¨ˆç®—å‰©é¤˜æ™‚é–“
                const now = Date.now();
                const remaining = Math.max(0, Math.ceil((timerState.endTime - now) / 1000));
                timerState.timeLeft = remaining;
                updateTimerDisplay();
                updateRestModalTimer();
                
                if (timerState.timeLeft <= 0) {
                    endRest();
                    showToast('âœ… æ¸¬è©¦å®Œæˆï¼');
                }
            }, 1000);

            showToast('â±ï¸ é–‹å§‹ 10 ç§’æ¸¬è©¦');
        }

        // ============================================
        // æ¸…é™¤è³‡æ–™
        // ============================================
        function clearAllData() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿé€™å°‡ç„¡æ³•å¾©åŸï¼')) {
                localStorage.removeItem('pomodoroProSettings');
                localStorage.removeItem('pomodoroProStats');
                localStorage.removeItem('pomodoroProTodos');
                location.reload();
            }
        }

        // ============================================
        // Toast
        // ============================================
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
